<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>">
    <title>4kéŸ³æ¸¸åº•åŠ›è®­ç»ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: white;
        }
        
        .sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 10;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            color: #FFD700;
        }
        
        .control-group {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #dee2e6;
            border-radius: 4px;
            outline: none;
        }
        
        .value-display {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            color: #FFD700;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #practiceBtn {
            background: #28a745;
            color: white;
        }
        
        #practiceBtn:hover {
            background: #218838;
        }
        
        #challengeBtn {
            background: #e74c3c;
            color: white;
        }
        
        #challengeBtn:hover {
            background: #c0392b;
        }
        
        #resetBtn {
            background: #dc3545;
            color: white;
        }
        
        #resetBtn:hover {
            background: #c82333;
        }
        
        #soundToggle {
            background: #17a2b8;
            color: white;
        }
        
        #soundToggle:hover {
            background: #138496;
        }
        
        #sponsorBtn {
            background: #9b59b6;
            color: white;
        }
        
        #sponsorBtn:hover {
            background: #8e44ad;
        }
        
        #toggleSidebar {
            position: fixed;
            top: 50%;
            left: 300px;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 0 5px 5px 0;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 20;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar.collapsed + #toggleSidebar {
            left: 60px;
        }
        
        #toggleSidebar:hover {
            background: rgba(0, 0, 0, 0.9);
            width: 25px;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: block;
            touch-action: none;
        }
        
        .game-stats {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 5;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .stat-label {
            font-size: 14px;
            color: #ccc;
            margin-top: 2px;
        }
        
        .judgement-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 5;
            text-align: center;
        }

        .judgement-subtext {
            font-size: 36px;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .start-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 30px 60px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            z-index: 10;
            pointer-events: none;
            width: 80%;
            max-width: 600px;
        }
        
        .combo-display {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 5;
        }
        
        .sidebar.collapsed {
            width: 60px;
            overflow: hidden;
            padding: 10px;
        }
        
        .sidebar.collapsed .control-group,
        .sidebar.collapsed .button-group,
        .sidebar.collapsed h1 {
            display: none;
        }
        
        .sidebar.collapsed .button-group {
            align-items: center;
        }
        
        .sidebar.collapsed button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .bpm-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .bpm-input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            text-align: center;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .bpm-input:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .bpm-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }
        
        /* ç§»åŠ¨ç«¯å¼€å§‹æŒ‰é’® */
        .mobile-start-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .mobile-start-btn:hover {
            background: #218838;
        }

        /* ç§»åŠ¨ç«¯æ ·å¼ */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                height: 100%;
                z-index: 30;
                transform: translateX(0);
                transition: transform 0.3s ease;
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            #toggleSidebar {
                left: 0;
                transform: translateY(-50%);
                border-radius: 0 5px 5px 0;
                width: 25px;
                height: 80px;
                background: rgba(0, 0, 0, 0.8);
                z-index: 35;
            }
            
            .sidebar.collapsed + #toggleSidebar {
                left: 0;
                transform: translateY(-50%);
            }
            
            .game-stats {
                flex-wrap: wrap;
                padding: 5px 10px;
            }
            
            .stat-item {
                flex: 1 0 25%;
                margin-bottom: 5px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            .start-hint {
                padding: 20px;
                font-size: 18px;
            }
            
            .start-hint h2 {
                font-size: 22px;
            }
            
            /* ç§»åŠ¨ç«¯å¼€å§‹æŒ‰é’®åœ¨æç¤ºæ¡†å†… */
            .hint-start-btn {
                display: block;
                margin: 20px auto;
                padding: 12px 25px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                pointer-events: auto;
            }
        }
        
        /* æ¸¸æˆç»“æŸå¼¹çª— */
        .game-over-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .game-over-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            color: #333;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }
        
        .game-over-content h2 {
            margin-bottom: 20px;
            color: #dc3545;
        }
        
        .game-over-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .game-over-stat {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .game-over-stat-label {
            font-weight: bold;
            color: #555;
        }
        
        .game-over-stat-value {
            color: #333;
        }
        
        .game-over-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .restart-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .restart-btn:hover {
            background: #218838;
        }
        
        .close-game-over-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .close-game-over-btn:hover {
            background: #5a6268;
        }
        
        .sponsor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .sponsor-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            color: #333;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }
        
        .sponsor-content h2 {
            margin-bottom: 20px;
            color: #9b59b6;
        }
        
        .sponsor-content p {
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .qr-codes {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 10px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            border: 1px solid #ddd;
            padding: 10px;
        }
        
        .qr-code img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .close-btn:hover {
            background: #c82333;
        }
        
        .cat-girl-text {
            font-family: 'Microsoft YaHei', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #555;
            text-align: left;
            margin-bottom: 20px;
            background: #f9f0ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .cat-girl-text::before {
            content: "ğŸ± ";
            font-size: 18px;
        }
        
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .no-context-menu {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .touch-feedback {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            pointer-events: none;
            z-index: 15;
            transition: opacity 0.2s;
        }
        
        .challenge-info {
            position: absolute;
            top: 80px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            color: #FFD700;
        }
        
        /* æ–°å¢æ ·å¼ */
        .performance-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #ccc;
        }
        
        .hit-effect {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transform: scale(0.5);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 5;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #FFD700);
            width: 0%;
            transition: width 0.3s;
        }
        
        .lane-highlight {
            position: absolute;
            top: 0;
            height: 100%;
            width: 25%;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.1s;
        }
    </style>
</head>
<body class="no-context-menu">
    <div class="sidebar" id="sidebar">
        <h1>ğŸµ4kåº•åŠ›è®­ç»ƒğŸµ</h1>
        
        <div class="control-group">
            <label>BPMï¼ˆæ¯åˆ†é’ŸèŠ‚æ‹æ•°ï¼‰</label>
            <div class="bpm-input-container">
                <input type="number" id="bpmInput" class="bpm-input" placeholder="60~9999" min="60" max="9999" value="120">
                <span>BPM</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>æ–¹å—æµé€Ÿ</label>
            <input type="range" id="speedSlider" min="0.5" max="5.0" value="1.0" step="0.1">
            <div class="value-display">
                <span>0.5x</span>
                <span id="speedValue">1.0x</span>
                <span>5.0x</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>åˆ¤å®šåŒºåŸŸå¤§å°</label>
            <input type="range" id="judgementSlider" min="1" max="10" value="5" step="1">
            <div class="value-display">
                <span>ä¸¥æ ¼</span>
                <span id="judgementValue">ä¸­ç­‰</span>
                <span>å®½æ¾</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>åˆ¤å®šçº¿ä½ç½®</label>
            <input type="range" id="linePositionSlider" min="20" max="80" value="70" step="5">
            <div class="value-display">
                <span>åº•éƒ¨</span>
                <span id="linePositionValue">70%</span>
                <span>é¡¶éƒ¨</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>æ¸¸æˆç»“æŸæ¡ä»¶ (MISSæ•°é‡)</label>
            <input type="range" id="missLimitSlider" min="1" max="20" value="5" step="1">
            <div class="value-display">
                <span>1</span>
                <span id="missLimitValue">5</span>
                <span>20</span>
            </div>
            <div style="margin-top: 10px;">
                <label>
                    <input type="checkbox" id="enableMissLimit" checked>
                    å¯ç”¨æ¸¸æˆç»“æŸæ¡ä»¶
                </label>
            </div>
        </div>
        
        <div class="button-group">
            <button id="practiceBtn">è®­ç»ƒæ¨¡å¼</button>
            <button id="challengeBtn">æŒ‘æˆ˜æ¨¡å¼</button>
            <button id="resetBtn">é‡ç½®</button>
            <button id="soundToggle">éŸ³æ•ˆ: å¼€å¯</button>
            <button id="sponsorBtn">èµåŠ©æ”¯æŒ</button>
        </div>
    </div>
    
    <!-- ä¾§è¾¹æ æ”¶çº³æŒ‰é’®æ”¾åœ¨ä¾§è¾¹æ å¤–éƒ¨ -->
    <button id="toggleSidebar">â—€</button>
    
    <div class="game-area">
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-value" id="score">0</div>
                <div class="stat-label">åˆ†æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="combo">0</div>
                <div class="stat-label">è¿å‡»</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxCombo">0</div>
                <div class="stat-label">æœ€å¤§è¿å‡»</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">100%</div>
                <div class="stat-label">å‡†ç¡®ç‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="perfectCount">0</div>
                <div class="stat-label">PERFECT</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="greatCount">0</div>
                <div class="stat-label">GREAT</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="goodCount">0</div>
                <div class="stat-label">GOOD</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="missCount">0</div>
                <div class="stat-label">MISS</div>
            </div>
        </div>
        
        <!-- è½¨é“é«˜äº®æ•ˆæœ -->
        <div class="lane-highlight" id="lane0"></div>
        <div class="lane-highlight" id="lane1"></div>
        <div class="lane-highlight" id="lane2"></div>
        <div class="lane-highlight" id="lane3"></div>
        
        <canvas id="gameCanvas"></canvas>
        <div class="judgement-display" id="judgementDisplay"></div>
        <div class="combo-display" id="comboDisplay"></div>
        
        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <!-- æŒ‘æˆ˜æ¨¡å¼ä¿¡æ¯æ˜¾ç¤º -->
        <div class="challenge-info" id="challengeInfo" style="display: none;">
            æŒ‘æˆ˜æ¨¡å¼: BPM <span id="currentBPM">240</span>
        </div>
        
        <!-- æ€§èƒ½æŒ‡ç¤ºå™¨ -->
        <div class="performance-indicator" id="performanceIndicator">
            FPS: 60
        </div>
        
        <!-- å¼€å§‹ä¸‹è½æŒ‰é’® - åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šæ˜¾ç¤º -->
        <button class="mobile-start-btn" id="mobileStartBtn">å¼€å§‹ä¸‹è½</button>
        
        <div class="start-hint" id="startHint" style="display: none;">
            <h2>ğŸµ 4kéŸ³æ¸¸åº•åŠ›è®­ç»ƒå™¨ ğŸµ</h2>
            <p style="margin: 20px 0; font-size: 28px;">æŒ‰ä¸‹ç©ºæ ¼é”®æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹éŸ³ç¬¦ä¸‹è½</p>
            <button class="hint-start-btn" id="hintStartBtn">å¼€å§‹ä¸‹è½</button>
            <div style="font-size: 18px; line-height: 1.8;">
                <p>ğŸ¯ åˆ†æ•°: PERFECT:100 | GREAT:80 | GOOD:60 | MISS:0</p>
                <p>â¸ï¸ ç©ºæ ¼é”®: å¼€å§‹/æš‚åœæ¸¸æˆ</p>
                <p id="currentSettings">âš¡ BPM: 120 | æµé€Ÿ: 1.0x</p>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div class="game-over-modal" id="gameOverModal">
        <div class="game-over-content">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p id="gameOverReason">æ‚¨çš„MISSæ•°é‡å·²è¾¾åˆ°è®¾å®šä¸Šé™ï¼Œæ¸¸æˆç»“æŸï¼</p>
            
            <div class="game-over-stats">
                <div class="game-over-stat">
                    <span class="game-over-stat-label">BPM:</span>
                    <span class="game-over-stat-value" id="gameOverBPM">120</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">æ–¹å—æµé€Ÿ:</span>
                    <span class="game-over-stat-value" id="gameOverSpeed">1.0x</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">åˆ¤å®šåŒºåŸŸ:</span>
                    <span class="game-over-stat-value" id="gameOverJudgement">ä¸­ç­‰</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">åˆ†æ•°:</span>
                    <span class="game-over-stat-value" id="gameOverScore">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">æœ€å¤§è¿å‡»:</span>
                    <span class="game-over-stat-value" id="gameOverMaxCombo">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">å‡†ç¡®ç‡:</span>
                    <span class="game-over-stat-value" id="gameOverAccuracy">100%</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">PERFECT:</span>
                    <span class="game-over-stat-value" id="gameOverPerfect">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">GREAT:</span>
                    <span class="game-over-stat-value" id="gameOverGreat">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">GOOD:</span>
                    <span class="game-over-stat-value" id="gameOverGood">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">MISS:</span>
                    <span class="game-over-stat-value" id="gameOverMiss">0</span>
                </div>
                <div class="game-over-stat">
                    <span class="game-over-stat-label">ç»“æŸæ¡ä»¶:</span>
                    <span class="game-over-stat-value" id="gameOverEndCondition">5 MISS</span>
                </div>
            </div>
            
            <div class="game-over-buttons">
                <button class="restart-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
                <button class="close-game-over-btn" id="closeGameOverBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- èµåŠ©å¼¹çª— -->
    <div class="sponsor-modal" id="sponsorModal">
        <div class="sponsor-content">
            <h2>å–µ~ æ„Ÿè°¢æ‚¨å–œæ¬¢è¿™ä¸ªéŸ³æ¸¸è®­ç»ƒå™¨ï¼</h2>
            
            <div class="cat-girl-text">
                å–µå‘œ~ é˜ä¸‹ç©å¾—å¼€å¿ƒå—ï¼Ÿå¯¹æ‚¨çš„åº•åŠ›æå‡æœ‰å¸®åŠ©çš„è¯ï¼Œå¯ä»¥è€ƒè™‘èµåŠ©æ”¯æŒä¸€ä¸‹å–µ~<br><br>
                
                æ‚¨çš„æ”¯æŒå°†å¸®åŠ©æˆ‘ç»§ç»­æ”¹è¿›å’Œå¼€å‘æ›´å¤šæœ‰è¶£çš„åŠŸèƒ½çš„å–µï¼<br><br>
                
                ç¥æ‚¨æ—©æ—¥è¾¾æˆå…¨è¿FCï¼Œå†²å‡»APå…¨å®Œç¾ï¼
            </div>
            
            <div class="qr-codes">
                <div class="qr-code">
                    <img src="WeChatQRCode.jpg" alt="å¾®ä¿¡æ”¶æ¬¾ç ">
                    <span>å¾®ä¿¡æ”¯ä»˜</span>
                </div>
                <div class="qr-code">
                    <img src="AlipayQRCode.jpg" alt="æ”¯ä»˜å®æ”¶æ¬¾ç ">
                    <span>æ”¯ä»˜å®</span>
                </div>
            </div>
            
            <p>æ‰«æä¸Šæ–¹äºŒç»´ç è¿›è¡ŒèµåŠ©ï¼Œæ„Ÿè°¢æ‚¨çš„æ”¯æŒå–µ~</p>
            <button class="close-btn" id="closeSponsorModal">å…³é—­</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒå˜é‡
        let game = {
            bpm: 120,
            speed: 1.0,
            judgementLevel: 5, // é»˜è®¤ä¸­ç­‰
            linePosition: 70,
            missLimit: 5, // é»˜è®¤5ä¸ªMISS
            enableMissLimit: true,
            isPlaying: false,
            notes: [],
            score: 0,
            combo: 0,
            maxCombo: 0,
            hitCount: 0,
            totalNotes: 0,
            perfectCount: 0,
            greatCount: 0,
            goodCount: 0,
            missCount: 0,
            noteInterval: null,
            animationFrame: null,
            // é‡æ–°è®¾è®¡æŒ‰é”®é«˜äº®ç³»ç»Ÿ
            keyPressStates: [false, false, false, false], // æ¯ä¸ªè½¨é“çš„æŒ‰é”®çŠ¶æ€
            keyPressTimes: [0, 0, 0, 0], // æ¯ä¸ªè½¨é“çš„æŒ‰é”®æ—¶é—´
            keyPressDuration: 100, // æŒ‰é”®é«˜äº®æŒç»­æ—¶é—´
            waitingForSpace: false,
            soundEnabled: true,
            // ç§»åŠ¨ç«¯è§¦æ‘¸ç›¸å…³
            touchActive: false,
            currentTouchLane: -1,
            touchFeedback: null,
            // ä¾§è¾¹æ çŠ¶æ€
            sidebarCollapsed: false,
            // æŒ‘æˆ˜æ¨¡å¼ç›¸å…³
            challengeMode: false,
            challengeTimer: null,
            challengeBPM: 240,
            challengeStartTime: 0, // æŒ‘æˆ˜æ¨¡å¼å¼€å§‹æ—¶é—´
            // æ€§èƒ½ä¼˜åŒ–ç›¸å…³
            lastFrameTime: 0,
            fps: 0,
            frameCount: 0,
            // éŸ³ç¬¦å¯¹è±¡æ± 
            notePool: [],
            maxPoolSize: 100,
            // å‘½ä¸­æ•ˆæœ
            hitEffects: [],
            // éŸ³ç¬¦ç”Ÿæˆç›¸å…³
            lastNoteTime: 0, // ä¸Šæ¬¡ç”ŸæˆéŸ³ç¬¦çš„æ—¶é—´
            noteGenerationInterval: 0 // å½“å‰éŸ³ç¬¦ç”Ÿæˆé—´éš”
        };

        // è·å–HTMLå…ƒç´ 
        let canvas, ctx;
        let bpmInput;
        let speedSlider, judgementSlider, linePositionSlider, missLimitSlider, enableMissLimitCheckbox;
        let speedValue, judgementValue, linePositionValue, missLimitValue;
        let practiceBtn, challengeBtn, resetBtn, toggleSidebar, soundToggle, sponsorBtn;
        let scoreDisplay, comboDisplay, accuracyDisplay, maxComboDisplay;
        let perfectCountDisplay, greatCountDisplay, goodCountDisplay, missCountDisplay;
        let judgementDisplay, startHint, comboDisplayElement, currentSettings;
        let gameOverModal, restartBtn, closeGameOverBtn;
        let sponsorModal, closeSponsorModal;
        let mobileStartBtn, hintStartBtn;
        let challengeInfo, currentBPM;
        let performanceIndicator, progressFill;
        let laneHighlights = [];

        // éŸ³æ•ˆ
        let audioContext;
        let soundBuffers = {};

        // é”®ç›˜æ˜ å°„
        const KEY_MAPPING = {
            'KeyD': 0,
            'KeyF': 1,  
            'KeyJ': 2,
            'KeyK': 3
        };

        // åˆ¤å®šçª—å£é…ç½® - è°ƒæ•´ä¸ºæ›´å®½æ¾çš„åˆ¤å®š
        const JUDGEMENT_CONFIG = {
            1: { perfect: 25, great: 50, good: 75 },
            2: { perfect: 30, great: 60, good: 90 },
            3: { perfect: 35, great: 70, good: 105 },
            4: { perfect: 40, great: 80, good: 120 },
            5: { perfect: 45, great: 90, good: 135 },
            6: { perfect: 50, great: 100, good: 150 },
            7: { perfect: 55, great: 110, good: 165 },
            8: { perfect: 60, great: 120, good: 180 },
            9: { perfect: 65, great: 130, good: 195 },
            10: { perfect: 70, great: 140, good: 210 }
        };

        // åˆ¤å®šæ–‡å­—æè¿°
        const JUDGEMENT_LABELS = {
            1: "è¶…ä¸¥æ ¼", 2: "ä¸¥æ ¼", 3: "è¾ƒä¸¥æ ¼", 4: "ç¨ä¸¥æ ¼", 5: "ä¸­ç­‰",
            6: "ç¨å®½æ¾", 7: "è¾ƒå®½æ¾", 8: "å®½æ¾", 9: "å¾ˆå®½æ¾", 10: "è¶…å®½æ¾"
        };

        // åˆ†æ•°é…ç½®
        const SCORE_CONFIG = {
            PERFECT: 100,
            GREAT: 80,
            GOOD: 60,
            MISS: 0
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            console.log('ğŸ® å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            
            try {
                // è·å–æ‰€æœ‰HTMLå…ƒç´ 
                canvas = document.getElementById('gameCanvas');
                if (!canvas) throw new Error('æ‰¾ä¸åˆ°canvaså…ƒç´ ');
                
                // è®¾ç½®canvaså°ºå¯¸ä¸ºå…¨å±
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                
                ctx = canvas.getContext('2d');
                if (!ctx) throw new Error('æ— æ³•è·å–canvasä¸Šä¸‹æ–‡');
                
                // è·å–è¾“å…¥å…ƒç´ 
                bpmInput = document.getElementById('bpmInput');
                speedSlider = document.getElementById('speedSlider');
                judgementSlider = document.getElementById('judgementSlider');
                linePositionSlider = document.getElementById('linePositionSlider');
                missLimitSlider = document.getElementById('missLimitSlider');
                enableMissLimitCheckbox = document.getElementById('enableMissLimit');
                
                // è·å–æ˜¾ç¤ºå…ƒç´ 
                speedValue = document.getElementById('speedValue');
                judgementValue = document.getElementById('judgementValue');
                linePositionValue = document.getElementById('linePositionValue');
                missLimitValue = document.getElementById('missLimitValue');
                
                // è·å–æŒ‰é’®å…ƒç´ 
                practiceBtn = document.getElementById('practiceBtn');
                challengeBtn = document.getElementById('challengeBtn');
                resetBtn = document.getElementById('resetBtn');
                toggleSidebar = document.getElementById('toggleSidebar');
                soundToggle = document.getElementById('soundToggle');
                sponsorBtn = document.getElementById('sponsorBtn');
                
                // è·å–ç§»åŠ¨ç«¯æŒ‰é’®
                mobileStartBtn = document.getElementById('mobileStartBtn');
                hintStartBtn = document.getElementById('hintStartBtn');
                
                // è·å–ç»Ÿè®¡å…ƒç´ 
                scoreDisplay = document.getElementById('score');
                comboDisplay = document.getElementById('combo');
                accuracyDisplay = document.getElementById('accuracy');
                maxComboDisplay = document.getElementById('maxCombo');
                perfectCountDisplay = document.getElementById('perfectCount');
                greatCountDisplay = document.getElementById('greatCount');
                goodCountDisplay = document.getElementById('goodCount');
                missCountDisplay = document.getElementById('missCount');
                
                // è·å–å…¶ä»–å…ƒç´ 
                judgementDisplay = document.getElementById('judgementDisplay');
                startHint = document.getElementById('startHint');
                comboDisplayElement = document.getElementById('comboDisplay');
                currentSettings = document.getElementById('currentSettings');
                
                // è·å–æŒ‘æˆ˜æ¨¡å¼å…ƒç´ 
                challengeInfo = document.getElementById('challengeInfo');
                currentBPM = document.getElementById('currentBPM');
                
                // è·å–æ¸¸æˆç»“æŸå¼¹çª—å…ƒç´ 
                gameOverModal = document.getElementById('gameOverModal');
                restartBtn = document.getElementById('restartBtn');
                closeGameOverBtn = document.getElementById('closeGameOverBtn');
                
                // è·å–èµåŠ©å¼¹çª—å…ƒç´ 
                sponsorModal = document.getElementById('sponsorModal');
                closeSponsorModal = document.getElementById('closeSponsorModal');
                
                // è·å–æ€§èƒ½æŒ‡ç¤ºå™¨å’Œè¿›åº¦æ¡
                performanceIndicator = document.getElementById('performanceIndicator');
                progressFill = document.getElementById('progressFill');
                
                // è·å–è½¨é“é«˜äº®å…ƒç´ 
                for (let i = 0; i < 4; i++) {
                    laneHighlights[i] = document.getElementById('lane' + i);
                }
                
                console.log('âœ… æ‰€æœ‰HTMLå…ƒç´ è·å–æˆåŠŸ');
                
                // åˆå§‹åŒ–éŸ³æ•ˆ
                initAudio();
                
                // åˆå§‹åŒ–éŸ³ç¬¦å¯¹è±¡æ± 
                initNotePool();
                
                // è®¾ç½®åˆå§‹å€¼
                updateSliderValues();
                
                // è®¾ç½®è¾“å…¥äº‹ä»¶
                setupInputs();
                
                // è®¾ç½®æŒ‰é’®äº‹ä»¶
                setupButtons();
                
                // è®¾ç½®é”®ç›˜å’Œè§¦æ‘¸äº‹ä»¶
                setupInputEvents();
                
                // åˆ›å»ºè§¦æ‘¸åé¦ˆå…ƒç´ 
                createTouchFeedback();
                
                // ç§»åŠ¨ç«¯é»˜è®¤ä¾§è¾¹æ æ‰“å¼€
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.remove('collapsed');
                    toggleSidebar.textContent = 'â–¶';
                }
                
                // åˆå§‹ç»˜åˆ¶
                drawGame();
                
                // å¼€å§‹FPSè®¡ç®—
                calculateFPS();
                
                console.log('ğŸ‰ æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                alert('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŒ–éŸ³ç¬¦å¯¹è±¡æ± 
        function initNotePool() {
            for (let i = 0; i < game.maxPoolSize; i++) {
                game.notePool.push({
                    id: 0,
                    lane: 0,
                    position: -50,
                    speed: 0,
                    hit: false,
                    missed: false,
                    judgement: null,
                    createTime: 0
                });
            }
        }

        // ä»å¯¹è±¡æ± è·å–éŸ³ç¬¦
        function getNoteFromPool(lane, speed) {
            if (game.notePool.length > 0) {
                const note = game.notePool.pop();
                note.id = Date.now() + Math.random();
                note.lane = lane;
                note.position = -50;
                note.speed = speed;
                note.hit = false;
                note.missed = false;
                note.judgement = null;
                note.createTime = Date.now();
                return note;
            }
            // å¦‚æœå¯¹è±¡æ± ä¸ºç©ºï¼Œåˆ›å»ºæ–°éŸ³ç¬¦
            return {
                id: Date.now() + Math.random(),
                lane: lane,
                position: -50,
                speed: speed,
                hit: false,
                missed: false,
                judgement: null,
                createTime: Date.now()
            };
        }

        // å°†éŸ³ç¬¦è¿”å›åˆ°å¯¹è±¡æ± 
        function returnNoteToPool(note) {
            if (game.notePool.length < game.maxPoolSize) {
                game.notePool.push(note);
            }
        }

        // è®¡ç®—FPS
        function calculateFPS() {
            const now = performance.now();
            if (game.lastFrameTime) {
                const delta = now - game.lastFrameTime;
                game.fps = Math.round(1000 / delta);
                
                // æ¯10å¸§æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
                if (game.frameCount % 10 === 0) {
                    performanceIndicator.textContent = `FPS: ${game.fps}`;
                }
            }
            game.lastFrameTime = now;
            game.frameCount++;
            
            requestAnimationFrame(calculateFPS);
        }

        // åˆ›å»ºè§¦æ‘¸åé¦ˆå…ƒç´ 
        function createTouchFeedback() {
            game.touchFeedback = document.createElement('div');
            game.touchFeedback.className = 'touch-feedback';
            game.touchFeedback.style.display = 'none';
            document.querySelector('.game-area').appendChild(game.touchFeedback);
        }

        // æ˜¾ç¤ºè§¦æ‘¸åé¦ˆ
        function showTouchFeedback(lane) {
            if (!game.touchFeedback) return;
            
            const laneWidth = canvas.width / 4;
            const x = lane * laneWidth;
            
            game.touchFeedback.style.left = x + 'px';
            game.touchFeedback.style.width = laneWidth + 'px';
            game.touchFeedback.style.height = canvas.height + 'px';
            game.touchFeedback.style.display = 'block';
            game.touchFeedback.style.opacity = '1';
        }

        // éšè—è§¦æ‘¸åé¦ˆ
        function hideTouchFeedback() {
            if (!game.touchFeedback) return;
            
            game.touchFeedback.style.opacity = '0';
            setTimeout(() => {
                game.touchFeedback.style.display = 'none';
            }, 200);
        }

        // è°ƒæ•´canvaså°ºå¯¸
        function resizeCanvas() {
            const gameArea = document.querySelector('.game-area');
            canvas.width = gameArea.clientWidth;
            canvas.height = gameArea.clientHeight;
            
            // é‡æ–°ç»˜åˆ¶æ¸¸æˆ
            if (ctx) {
                drawGame();
            }
        }

        // åˆå§‹åŒ–éŸ³æ•ˆ
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºéŸ³æ•ˆ
                createSound('perfect', 800, 0.3);
                createSound('great', 600, 0.25);
                createSound('good', 400, 0.2);
                createSound('miss', 200, 0.3);
                createSound('click', 300, 0.1);
                
                console.log('ğŸ”Š éŸ³æ•ˆåˆå§‹åŒ–æˆåŠŸ');
            } catch (e) {
                console.error('âŒ éŸ³æ•ˆåˆå§‹åŒ–å¤±è´¥:', e);
                game.soundEnabled = false;
                soundToggle.textContent = 'éŸ³æ•ˆ: å…³é—­';
            }
        }

        // åˆ›å»ºéŸ³æ•ˆ
        function createSound(name, frequency, duration) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
            
            // å­˜å‚¨éŸ³æ•ˆ
            soundBuffers[name] = { oscillator, gainNode };
        }

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(name) {
            if (!game.soundEnabled || !audioContext) return;
            
            try {
                createSound(name, 
                    name === 'perfect' ? 800 : 
                    name === 'great' ? 600 : 
                    name === 'good' ? 400 : 
                    name === 'miss' ? 200 : 300, 
                    0.2);
            } catch (e) {
                console.error('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
            }
        }

        // æ›´æ–°æ˜¾ç¤ºå€¼
        function updateSliderValues() {
            speedValue.textContent = game.speed.toFixed(1) + 'x';
            judgementValue.textContent = JUDGEMENT_LABELS[game.judgementLevel];
            linePositionValue.textContent = game.linePosition + '%';
            missLimitValue.textContent = game.missLimit;
            
            // æ›´æ–°å¼€å§‹æç¤ºä¸­çš„è®¾ç½®
            if (currentSettings) {
                if (game.challengeMode) {
                    currentSettings.textContent = 'âš¡ æŒ‘æˆ˜æ¨¡å¼ | æµé€Ÿ: ' + game.speed.toFixed(1) + 'x';
                } else {
                    currentSettings.textContent = `âš¡ BPM: ${game.bpm} | æµé€Ÿ: ${game.speed.toFixed(1)}x`;
                }
            }
        }

        // å®‰å…¨è¾“å…¥éªŒè¯å‡½æ•°
        function sanitizeInput(value, min, max, defaultValue) {
            // è½¬æ¢ä¸ºæ•°å­—
            let numValue = parseInt(value);
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(numValue)) {
                return defaultValue;
            }
            
            // é™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…
            numValue = Math.max(min, Math.min(max, numValue));
            
            return numValue;
        }

        // æ›´æ–°BPMå€¼
        function updateBPM() {
            let value = sanitizeInput(bpmInput.value, 60, 9999, 120);
            game.bpm = value;
            bpmInput.value = value; // ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯å®‰å…¨å€¼
            updateSliderValues();
            
            if (game.isPlaying && !game.waitingForSpace) {
                restartGame();
            }
        }

        // è®¾ç½®è¾“å…¥äº‹ä»¶
        function setupInputs() {
            // BPMè¾“å…¥æ¡†äº‹ä»¶ - åªåœ¨å¤±å»ç„¦ç‚¹æˆ–æŒ‰å›è½¦æ—¶æ›´æ–°
            bpmInput.addEventListener('blur', function() {
                updateBPM();
            });
            
            // æŒ‰å›è½¦é”®æ—¶æ›´æ–°BPM
            bpmInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    updateBPM();
                    this.blur(); // å¤±å»ç„¦ç‚¹ï¼Œéšè—é”®ç›˜ï¼ˆåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼‰
                }
            });

            speedSlider.addEventListener('input', function() {
                game.speed = parseFloat(this.value);
                updateSliderValues();
                if (game.isPlaying && !game.waitingForSpace) {
                    restartGame();
                }
            });

            judgementSlider.addEventListener('input', function() {
                game.judgementLevel = parseInt(this.value);
                updateSliderValues();
                drawGame(); // ç«‹å³æ›´æ–°ç”»é¢
            });

            linePositionSlider.addEventListener('input', function() {
                game.linePosition = parseInt(this.value);
                updateSliderValues();
                drawGame(); // ç«‹å³æ›´æ–°ç”»é¢
            });
            
            missLimitSlider.addEventListener('input', function() {
                game.missLimit = parseInt(this.value);
                updateSliderValues();
            });
            
            enableMissLimitCheckbox.addEventListener('change', function() {
                game.enableMissLimit = this.checked;
            });
        }

        // è®¾ç½®æŒ‰é’®äº‹ä»¶
        function setupButtons() {
            practiceBtn.addEventListener('click', startPracticeMode);
            challengeBtn.addEventListener('click', startChallengeMode);
            resetBtn.addEventListener('click', resetGame);
            
            // å¼€å§‹ä¸‹è½æŒ‰é’® - æ˜ å°„ä¸ºç©ºæ ¼é”®äº‹ä»¶
            mobileStartBtn.addEventListener('click', function() {
                // åˆ›å»ºå¹¶è§¦å‘ç©ºæ ¼é”®æŒ‰ä¸‹äº‹ä»¶
                const spaceEvent = new KeyboardEvent('keydown', {
                    code: 'Space',
                    key: ' ',
                    keyCode: 32,
                    which: 32,
                    bubbles: true
                });
                document.dispatchEvent(spaceEvent);
            });
            
            hintStartBtn.addEventListener('click', function() {
                // åˆ›å»ºå¹¶è§¦å‘ç©ºæ ¼é”®æŒ‰ä¸‹äº‹ä»¶
                const spaceEvent = new KeyboardEvent('keydown', {
                    code: 'Space',
                    key: ' ',
                    keyCode: 32,
                    which: 32,
                    bubbles: true
                });
                document.dispatchEvent(spaceEvent);
            });
            
            // ä¾§è¾¹æ åˆ‡æ¢
            toggleSidebar.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // ç§»åŠ¨ç«¯ï¼šä¾§è¾¹æ æ»‘åŠ¨
                    sidebar.classList.toggle('collapsed');
                    this.textContent = sidebar.classList.contains('collapsed') ? 'â–¶' : 'â—€';
                } else {
                    // æ¡Œé¢ç«¯ï¼šä¾§è¾¹æ æ”¶èµ·/å±•å¼€
                    sidebar.classList.toggle('collapsed');
                    game.sidebarCollapsed = sidebar.classList.contains('collapsed');
                    this.textContent = game.sidebarCollapsed ? 'â–¶' : 'â—€';
                    
                    // æ›´æ–°æŒ‰é’®ä½ç½®
                    const newLeft = game.sidebarCollapsed ? 60 : 300;
                    this.style.left = newLeft + 'px';
                }
                
                // é‡æ–°è°ƒæ•´canvaså¤§å°
                setTimeout(resizeCanvas, 300);
            });
            
            // éŸ³æ•ˆåˆ‡æ¢
            soundToggle.addEventListener('click', function() {
                game.soundEnabled = !game.soundEnabled;
                this.textContent = game.soundEnabled ? 'éŸ³æ•ˆ: å¼€å¯' : 'éŸ³æ•ˆ: å…³é—­';
                playSound('click');
            });
            
            // èµåŠ©æŒ‰é’®
            sponsorBtn.addEventListener('click', function() {
                sponsorModal.style.display = 'flex';
                playSound('click');
            });
            
            // å…³é—­èµåŠ©å¼¹çª—
            closeSponsorModal.addEventListener('click', function() {
                sponsorModal.style.display = 'none';
            });
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            sponsorModal.addEventListener('click', function(e) {
                if (e.target === sponsorModal) {
                    sponsorModal.style.display = 'none';
                }
            });
            
            // æ¸¸æˆç»“æŸå¼¹çª—æŒ‰é’®
            restartBtn.addEventListener('click', function() {
                gameOverModal.style.display = 'none';
                resetGame();
                if (game.challengeMode) {
                    startChallengeMode();
                } else {
                    startPracticeMode();
                }
            });
            
            closeGameOverBtn.addEventListener('click', function() {
                gameOverModal.style.display = 'none';
                resetGame();
            });
        }

        // è®¾ç½®è¾“å…¥äº‹ä»¶
        function setupInputEvents() {
            // ç”»å¸ƒç‚¹å‡»äº‹ä»¶
            canvas.addEventListener('click', handleCanvasClick);
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });
            
            // é˜²æ­¢é¡µé¢æ»šåŠ¨
            document.addEventListener('touchmove', function(e) {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space') {
                    e.preventDefault();
                }
            });
            
            // é˜²æ­¢å³é”®èœå•
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
        }

        // å¤„ç†è§¦æ‘¸å¼€å§‹
        function handleTouchStart(event) {
            if (!game.isPlaying || game.waitingForSpace) return;
            
            event.preventDefault();
            game.touchActive = true;
            
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            
            // ä¿®å¤ä¾§è¾¹æ æ”¶èµ·æ—¶çš„è§¦æ‘¸å®šä½é—®é¢˜
            let adjustedX = x;
            if (game.sidebarCollapsed && window.innerWidth > 768) {
                // ä¾§è¾¹æ æ”¶èµ·æ—¶ï¼Œcanvaså·¦ä¾§æœ‰60pxçš„ä¾§è¾¹æ ç©ºé—´
                adjustedX = x - 60;
            }
            
            const laneWidth = canvas.width / 4;
            const lane = Math.floor(adjustedX / laneWidth);
            
            // ç¡®ä¿laneåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (lane < 0 || lane > 3) return;
            
            game.currentTouchLane = lane;
            // ä½¿ç”¨æ–°çš„æŒ‰é”®çŠ¶æ€ç³»ç»Ÿ
            game.keyPressStates[lane] = true;
            game.keyPressTimes[lane] = Date.now();
            
            showTouchFeedback(lane);
            checkHit(lane);
        }

        // å¤„ç†è§¦æ‘¸ç§»åŠ¨
        function handleTouchMove(event) {
            if (!game.touchActive || !game.isPlaying || game.waitingForSpace) return;
            
            event.preventDefault();
            
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            
            // ä¿®å¤ä¾§è¾¹æ æ”¶èµ·æ—¶çš„è§¦æ‘¸å®šä½é—®é¢˜
            let adjustedX = x;
            if (game.sidebarCollapsed && window.innerWidth > 768) {
                adjustedX = x - 60;
            }
            
            const laneWidth = canvas.width / 4;
            const lane = Math.floor(adjustedX / laneWidth);
            
            // ç¡®ä¿laneåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (lane < 0 || lane > 3) return;
            
            // å¦‚æœç§»åŠ¨åˆ°æ–°çš„è½¨é“ï¼Œè§¦å‘è¯¥è½¨é“çš„æŒ‰é”®
            if (lane !== game.currentTouchLane) {
                game.currentTouchLane = lane;
                // ä½¿ç”¨æ–°çš„æŒ‰é”®çŠ¶æ€ç³»ç»Ÿ
                game.keyPressStates[lane] = true;
                game.keyPressTimes[lane] = Date.now();
                
                showTouchFeedback(lane);
                checkHit(lane);
            }
        }

        // å¤„ç†è§¦æ‘¸ç»“æŸ
        function handleTouchEnd(event) {
            event.preventDefault();
            game.touchActive = false;
            game.currentTouchLane = -1;
            // ä½¿ç”¨æ–°çš„æŒ‰é”®çŠ¶æ€ç³»ç»Ÿ - æ¸…é™¤æ‰€æœ‰è½¨é“çš„æŒ‰é”®çŠ¶æ€
            for (let i = 0; i < 4; i++) {
                game.keyPressStates[i] = false;
            }
            hideTouchFeedback();
        }

        // è·å–åˆ¤å®šçº¿Yåæ ‡
        function getJudgementLineY() {
            return canvas.height * (game.linePosition / 100);
        }

        // å¤„ç†é”®ç›˜æŒ‰ä¸‹
        function handleKeyDown(event) {
            // ç©ºæ ¼é”®å¤„ç†
            if (event.code === 'Space') {
                event.preventDefault();
                
                if (game.waitingForSpace) {
                    console.log('ğŸµ å¼€å§‹éŸ³ç¬¦ç”Ÿæˆ');
                    game.waitingForSpace = false;
                    startHint.style.display = 'none';
                    mobileStartBtn.style.display = 'none';
                    
                    // ç§»åŠ¨ç«¯å¼€å§‹è®­ç»ƒåè‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ 
                    if (window.innerWidth <= 768) {
                        const sidebar = document.getElementById('sidebar');
                        sidebar.classList.add('collapsed');
                        toggleSidebar.textContent = 'â–¶';
                    }
                    
                    startNoteGeneration();
                } else if (game.isPlaying) {
                    console.log('â¸ï¸ æš‚åœ/ç»§ç»­æ¸¸æˆ');
                    pauseGame();
                } else {
                    // æ¸¸æˆæš‚åœçŠ¶æ€ä¸‹æŒ‰ç©ºæ ¼é”®ç»§ç»­æ¸¸æˆ
                    pauseGame();
                }
                return;
            }
            
            if (!game.isPlaying || game.waitingForSpace) return;
            
            const lane = KEY_MAPPING[event.code];
            if (lane !== undefined) {
                // ä½¿ç”¨æ–°çš„æŒ‰é”®çŠ¶æ€ç³»ç»Ÿ - åªè®¾ç½®å¯¹åº”è½¨é“çš„çŠ¶æ€
                game.keyPressStates[lane] = true;
                game.keyPressTimes[lane] = Date.now();
                
                checkHit(lane);
                event.preventDefault();
            }
        }

        // å¤„ç†é”®ç›˜é‡Šæ”¾
        function handleKeyUp(event) {
            const lane = KEY_MAPPING[event.code];
            if (lane !== undefined) {
                // ä½¿ç”¨æ–°çš„æŒ‰é”®çŠ¶æ€ç³»ç»Ÿ - åªæ¸…é™¤å¯¹åº”è½¨é“çš„çŠ¶æ€
                game.keyPressStates[lane] = false;
                
                event.preventDefault();
            }
        }

        // è®¡ç®—éŸ³ç¬¦ç”Ÿæˆé—´éš”
        function calculateNoteInterval() {
            const currentBPM = game.challengeMode ? game.challengeBPM : game.bpm;
            // ç¡®ä¿BPMæœ‰æ•ˆ
            const safeBPM = Math.max(60, Math.min(9999, currentBPM));
            // æ¯æ‹çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œè¿™é‡Œä½¿ç”¨å››åˆ†éŸ³ç¬¦é—´éš”
            return (60000 / safeBPM);
        }

        // å¼€å§‹è®­ç»ƒæ¨¡å¼
        function startPracticeMode() {
            console.log('ğŸš€ å¼€å§‹è®­ç»ƒæ¨¡å¼');
            if (game.isPlaying) return;
            
            // ç¡®ä¿BPMæ˜¯æœ€æ–°çš„
            updateBPM();
            
            resetGameState();
            game.isPlaying = true;
            game.waitingForSpace = true;
            game.challengeMode = false;
            
            updateStats();
            startHint.style.display = 'block';
            
            // æ˜¾ç¤ºå¼€å§‹ä¸‹è½æŒ‰é’®
            mobileStartBtn.style.display = 'block';
            
            // éšè—æŒ‘æˆ˜æ¨¡å¼ä¿¡æ¯
            challengeInfo.style.display = 'none';
            
            gameLoop();
            
            practiceBtn.textContent = "è®­ç»ƒä¸­...";
            practiceBtn.disabled = true;
            challengeBtn.disabled = false;
            
            console.log('ğŸ”„ è®­ç»ƒæ¨¡å¼å¯åŠ¨ï¼Œç­‰å¾…ç©ºæ ¼é”®...');
        }

        // å¼€å§‹æŒ‘æˆ˜æ¨¡å¼
        function startChallengeMode() {
            console.log('ğŸ”¥ å¼€å§‹æŒ‘æˆ˜æ¨¡å¼');
            if (game.isPlaying) return;
            
            resetGameState();
            game.isPlaying = true;
            game.waitingForSpace = true;
            game.challengeMode = true;
            game.challengeBPM = 120; // é‡ç½®ä¸ºåˆå§‹å€¼
            game.challengeStartTime = Date.now(); // è®°å½•æŒ‘æˆ˜å¼€å§‹æ—¶é—´
            
            updateStats();
            startHint.style.display = 'block';
            
            // æ˜¾ç¤ºå¼€å§‹ä¸‹è½æŒ‰é’®
            mobileStartBtn.style.display = 'block';
            
            // æ˜¾ç¤ºæŒ‘æˆ˜æ¨¡å¼ä¿¡æ¯
            challengeInfo.style.display = 'block';
            currentBPM.textContent = Math.round(game.challengeBPM);
            
            gameLoop();
            
            challengeBtn.textContent = "æŒ‘æˆ˜ä¸­...";
            challengeBtn.disabled = true;
            practiceBtn.disabled = false;
            
            console.log('ğŸ”„ æŒ‘æˆ˜æ¨¡å¼å¯åŠ¨ï¼Œç­‰å¾…ç©ºæ ¼é”®...');
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGameState() {
            // å°†æ‰€æœ‰éŸ³ç¬¦è¿”å›åˆ°å¯¹è±¡æ± 
            game.notes.forEach(note => returnNoteToPool(note));
            game.notes = [];
            
            game.score = 0;
            game.combo = 0;
            game.maxCombo = 0;
            game.hitCount = 0;
            game.totalNotes = 0;
            game.perfectCount = 0;
            game.greatCount = 0;
            game.goodCount = 0;
            game.missCount = 0;
            // é‡ç½®æŒ‰é”®çŠ¶æ€
            for (let i = 0; i < 4; i++) {
                game.keyPressStates[i] = false;
            }
            game.waitingForSpace = false;
            game.touchActive = false;
            game.currentTouchLane = -1;
            game.lastNoteTime = 0;
            
            // æ¸…é™¤æŒ‘æˆ˜æ¨¡å¼è®¡æ—¶å™¨
            if (game.challengeTimer) {
                clearInterval(game.challengeTimer);
                game.challengeTimer = null;
            }
            
            // éšè—æ‰€æœ‰è½¨é“é«˜äº®
            laneHighlights.forEach(lane => {
                lane.style.opacity = '0';
            });
            
            // é‡ç½®è¿›åº¦æ¡
            progressFill.style.width = '0%';
        }

        // å¼€å§‹éŸ³ç¬¦ç”Ÿæˆ
        function startNoteGeneration() {
            // æ¸…é™¤ç°æœ‰çš„éŸ³ç¬¦ç”Ÿæˆå™¨
            if (game.noteInterval) {
                clearTimeout(game.noteInterval);
                game.noteInterval = null;
            }
            
            // ç«‹å³åˆ›å»ºä¸€ä¸ªéŸ³ç¬¦
            createNote();
            
            // è®¾ç½®éŸ³ç¬¦ç”Ÿæˆé—´éš”
            function scheduleNextNote() {
                const interval = calculateNoteInterval();
                game.noteInterval = setTimeout(() => {
                    createNote();
                    scheduleNextNote(); // é€’å½’è°ƒç”¨ä»¥å®‰æ’ä¸‹ä¸€ä¸ªéŸ³ç¬¦
                }, interval);
            }
            
            scheduleNextNote(); // å¼€å§‹è°ƒåº¦éŸ³ç¬¦
        }

        // æš‚åœæ¸¸æˆ
        function pauseGame() {
            if (game.waitingForSpace) return;
            
            console.log('â¸ï¸ åˆ‡æ¢æš‚åœçŠ¶æ€');
            game.isPlaying = !game.isPlaying;
            
            if (!game.isPlaying) {
                if (game.noteInterval) {
                    clearTimeout(game.noteInterval);
                    game.noteInterval = null;
                }
            } else {
                // æ¸¸æˆç»§ç»­æ—¶é‡æ–°å¼€å§‹éŸ³ç¬¦ç”Ÿæˆ
                startNoteGeneration();
                gameLoop(); // é‡æ–°å¼€å§‹æ¸¸æˆå¾ªç¯
            }
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            console.log('ğŸ”„ é‡ç½®æ¸¸æˆ');
            game.isPlaying = false;
            game.waitingForSpace = false;
            game.challengeMode = false;
            
            if (game.noteInterval) {
                clearTimeout(game.noteInterval);
                game.noteInterval = null;
            }
            
            if (game.challengeTimer) {
                clearInterval(game.challengeTimer);
                game.challengeTimer = null;
            }
            
            if (game.animationFrame) {
                cancelAnimationFrame(game.animationFrame);
                game.animationFrame = null;
            }
            
            resetGameState();
            updateStats();
            drawGame();
            
            startHint.style.display = 'none';
            mobileStartBtn.style.display = 'none';
            challengeInfo.style.display = 'none';
            practiceBtn.textContent = "è®­ç»ƒæ¨¡å¼";
            practiceBtn.disabled = false;
            challengeBtn.textContent = "æŒ‘æˆ˜æ¨¡å¼";
            challengeBtn.disabled = false;
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            console.log('ğŸ”„ é‡æ–°å¼€å§‹æ¸¸æˆ');
            if (!game.isPlaying) return;
            
            const wasPlaying = game.isPlaying;
            const wasChallenge = game.challengeMode;
            resetGame();
            if (wasPlaying) {
                if (wasChallenge) {
                    startChallengeMode();
                } else {
                    startPracticeMode();
                }
            }
        }

        // åˆ›å»ºæ–°éŸ³ç¬¦
        function createNote() {
            const lane = Math.floor(Math.random() * 4);
            // éŸ³ç¬¦é€Ÿåº¦åªåŸºäºç”¨æˆ·è®¾å®šçš„æµé€Ÿï¼Œä¸éšBPMå˜åŒ–
            const adjustedSpeed = 2 + (game.speed * 3);
            
            const note = getNoteFromPool(lane, adjustedSpeed);
            game.notes.push(note);
            game.totalNotes++;
            updateStats();
            
            console.log('ğŸµ åˆ›å»ºéŸ³ç¬¦ï¼Œè½¨é“:', lane, 'æ€»æ•°:', game.notes.length);
        }

        // å¤„ç†ç”»å¸ƒç‚¹å‡»
        function handleCanvasClick(event) {
            if (!game.isPlaying || game.waitingForSpace) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            
            // ä¿®å¤ä¾§è¾¹æ æ”¶èµ·æ—¶çš„ç‚¹å‡»å®šä½é—®é¢˜
            let adjustedX = x;
            if (game.sidebarCollapsed && window.innerWidth > 768) {
                adjustedX = x - 60;
            }
            
            const laneWidth = canvas.width / 4;
            const clickLane = Math.floor(adjustedX / laneWidth);
            
            // ç¡®ä¿laneåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (clickLane < 0 || clickLane > 3) return;
            
            // ä½¿ç”¨æ–°çš„æŒ‰é”®çŠ¶æ€ç³»ç»Ÿ
            game.keyPressStates[clickLane] = true;
            game.keyPressTimes[clickLane] = Date.now();
            
            checkHit(clickLane);
        }

        // æ£€æŸ¥ç‚¹å‡»åˆ¤å®š
        function checkHit(clickLane) {
            let hitFound = false;
            const judgementLineY = getJudgementLineY();
            const config = JUDGEMENT_CONFIG[game.judgementLevel];
            
            for (let i = 0; i < game.notes.length; i++) {
                const note = game.notes[i];
                
                if (note.hit || note.missed) continue;
                if (note.lane !== clickLane) continue;
                
                const distanceToLine = Math.abs(note.position - judgementLineY);
                
                if (distanceToLine <= config.perfect) {
                    processHit(note, 'PERFECT', '#FFD700', SCORE_CONFIG.PERFECT);
                    hitFound = true;
                    break;
                } else if (distanceToLine <= config.great) {
                    // åˆ¤æ–­æ˜¯EARLYè¿˜æ˜¯LATE
                    const timing = note.position < judgementLineY ? 'EARLY' : 'LATE';
                    processHit(note, 'GREAT', '#00FF00', SCORE_CONFIG.GREAT, timing);
                    hitFound = true;
                    break;
                } else if (distanceToLine <= config.good) {
                    // åˆ¤æ–­æ˜¯EARLYè¿˜æ˜¯LATE
                    const timing = note.position < judgementLineY ? 'EARLY' : 'LATE';
                    processHit(note, 'GOOD', '#3498db', SCORE_CONFIG.GOOD, timing);
                    hitFound = true;
                    break;
                }
            }
            
            // ä¸å†åœ¨æ²¡æœ‰å‘½ä¸­æ—¶è‡ªåŠ¨è®°å½•MISS
            // åªæœ‰å½“éŸ³ç¬¦é€šè¿‡åˆ¤å®šåŒºåŸŸæ—¶æ‰ä¼šè¢«æ ‡è®°ä¸ºMISS
            
            game.maxCombo = Math.max(game.maxCombo, game.combo);
            updateStats();
        }

        // å¤„ç†å‘½ä¸­é€»è¾‘
        function processHit(note, judgement, color, score, timing = null) {
            note.hit = true;
            note.judgement = judgement;
            
            // å¦‚æœæœ‰timingä¿¡æ¯ï¼Œæ˜¾ç¤ºEARLYæˆ–LATE
            if (timing) {
                showJudgement(judgement, color, timing);
            } else {
                showJudgement(judgement, color);
            }
            
            // æ˜¾ç¤ºå‘½ä¸­æ•ˆæœ
            showHitEffect(note.lane, note.position);
            
            game.score += score;
            game.combo++;
            game.hitCount++;
            
            if (judgement === 'PERFECT') {
                game.perfectCount++;
                playSound('perfect');
            } else if (judgement === 'GREAT') {
                game.greatCount++;
                playSound('great');
            } else if (judgement === 'GOOD') {
                game.goodCount++;
                playSound('good');
            }
            
            updateComboDisplay();
        }

        // æ˜¾ç¤ºå‘½ä¸­æ•ˆæœ
        function showHitEffect(lane, y) {
            const laneWidth = canvas.width / 4;
            const x = lane * laneWidth + laneWidth / 2;
            
            const effect = document.createElement('div');
            effect.className = 'hit-effect';
            effect.style.left = (x - 30) + 'px';
            effect.style.top = (y - 30) + 'px';
            document.querySelector('.game-area').appendChild(effect);
            
            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                effect.style.opacity = '1';
                effect.style.transform = 'scale(1.5)';
            }, 10);
            
            // ç§»é™¤æ•ˆæœ
            setTimeout(() => {
                effect.style.opacity = '0';
                setTimeout(() => {
                    if (effect.parentNode) {
                        effect.parentNode.removeChild(effect);
                    }
                }, 300);
            }, 300);
        }

        // æ˜¾ç¤ºåˆ¤å®šæ•ˆæœ
        function showJudgement(text, color, timing = null) {
            if (timing) {
                judgementDisplay.innerHTML = `
                    <div>${text}</div>
                    <div class="judgement-subtext">${timing}</div>
                `;
            } else {
                judgementDisplay.innerHTML = `<div>${text}</div>`;
            }
            
            judgementDisplay.style.color = color;
            judgementDisplay.style.opacity = '1';
            
            setTimeout(() => {
                judgementDisplay.style.opacity = '0';
            }, 500);
        }

        // æ›´æ–°è¿å‡»æ˜¾ç¤º
        function updateComboDisplay() {
            if (game.combo > 0) {
                comboDisplayElement.textContent = game.combo + ' COMBO!';
                comboDisplayElement.style.opacity = '1';
                
                // æ ¹æ®è¿å‡»æ•°æ”¹å˜é¢œè‰²
                if (game.combo >= 50) {
                    comboDisplayElement.style.color = '#FF00FF';
                } else if (game.combo >= 30) {
                    comboDisplayElement.style.color = '#00FFFF';
                } else if (game.combo >= 10) {
                    comboDisplayElement.style.color = '#00FF00';
                } else {
                    comboDisplayElement.style.color = '#FFD700';
                }
                
                setTimeout(() => {
                    comboDisplayElement.style.opacity = '0';
                }, 1000);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            scoreDisplay.textContent = game.score;
            comboDisplay.textContent = game.combo;
            maxComboDisplay.textContent = game.maxCombo;
            perfectCountDisplay.textContent = game.perfectCount;
            greatCountDisplay.textContent = game.greatCount;
            goodCountDisplay.textContent = game.goodCount;
            missCountDisplay.textContent = game.missCount;
            
            // æ–°çš„å‡†ç¡®ç‡è®¡ç®—æ–¹å¼ï¼šå‡†ç¡®ç‡ = (å½“å‰æ€»åˆ† / (å·²åˆ¤å®šéŸ³ç¬¦æ•° Ã— 100)) Ã— 100
            const judgedNotes = game.hitCount + game.missCount;
            let accuracy = 100;
            
            if (judgedNotes > 0) {
                // æ¯ä¸ªéŸ³ç¬¦æ»¡åˆ†æ˜¯100åˆ†ï¼Œæ‰€ä»¥å·²åˆ¤å®šéŸ³ç¬¦æ•°çš„æ»¡åˆ†æ˜¯ judgedNotes Ã— 100
                const maxPossibleScore = judgedNotes * 100;
                accuracy = (game.score / maxPossibleScore) * 100;
            }
            
            accuracyDisplay.textContent = accuracy.toFixed(1) + '%';
            
            // æ›´æ–°è¿›åº¦æ¡
            if (game.enableMissLimit) {
                const progress = (game.missCount / game.missLimit) * 100;
                progressFill.style.width = Math.min(progress, 100) + '%';
                
                // æ ¹æ®è¿›åº¦æ”¹å˜é¢œè‰²
                if (progress > 80) {
                    progressFill.style.background = 'linear-gradient(90deg, #dc3545, #ff6b6b)';
                } else if (progress > 60) {
                    progressFill.style.background = 'linear-gradient(90deg, #fd7e14, #ffa94d)';
                } else {
                    progressFill.style.background = 'linear-gradient(90deg, #28a745, #FFD700)';
                }
            }
            
            // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
            if (game.enableMissLimit && game.missCount >= game.missLimit) {
                gameOver('miss');
            }
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(reason) {
            console.log('ğŸ® æ¸¸æˆç»“æŸ');
            game.isPlaying = false;
            
            if (game.noteInterval) {
                clearTimeout(game.noteInterval);
                game.noteInterval = null;
            }
            
            if (game.challengeTimer) {
                clearInterval(game.challengeTimer);
                game.challengeTimer = null;
            }
            
            if (game.animationFrame) {
                cancelAnimationFrame(game.animationFrame);
                game.animationFrame = null;
            }
            
            // æ›´æ–°æ¸¸æˆç»“æŸå¼¹çª—æ•°æ®
            document.getElementById('gameOverBPM').textContent = game.challengeMode ? Math.round(game.challengeBPM) : game.bpm;
            document.getElementById('gameOverSpeed').textContent = game.speed.toFixed(1) + 'x';
            document.getElementById('gameOverJudgement').textContent = JUDGEMENT_LABELS[game.judgementLevel];
            document.getElementById('gameOverScore').textContent = game.score;
            document.getElementById('gameOverMaxCombo').textContent = game.maxCombo;
            document.getElementById('gameOverAccuracy').textContent = accuracyDisplay.textContent;
            document.getElementById('gameOverPerfect').textContent = game.perfectCount;
            document.getElementById('gameOverGreat').textContent = game.greatCount;
            document.getElementById('gameOverGood').textContent = game.goodCount;
            document.getElementById('gameOverMiss').textContent = game.missCount;
            document.getElementById('gameOverEndCondition').textContent = game.missLimit + ' MISS';
            
            // è®¾ç½®æ¸¸æˆç»“æŸåŸå› 
            if (reason === 'miss') {
                document.getElementById('gameOverReason').textContent = 'æ‚¨çš„MISSæ•°é‡å·²è¾¾åˆ°è®¾å®šä¸Šé™ï¼Œæ¸¸æˆç»“æŸï¼';
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
            gameOverModal.style.display = 'flex';
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!game.isPlaying) return;
            
            // æ›´æ–°æŒ‘æˆ˜æ¨¡å¼BPMï¼ˆè¿ç»­å¹³æ»‘å¢åŠ ï¼‰
            if (game.challengeMode && game.isPlaying && !game.waitingForSpace) {
                // è®¡ç®—ä»æŒ‘æˆ˜å¼€å§‹ç»è¿‡çš„æ—¶é—´ï¼ˆç§’ï¼‰
                const elapsedSeconds = (Date.now() - game.challengeStartTime) / 1000;
                // æ¯ç§’å¢åŠ 10BPM
                game.challengeBPM = 120 + (elapsedSeconds * 5);
                if (game.challengeBPM > 9999) game.challengeBPM = 9999;
                currentBPM.textContent = Math.round(game.challengeBPM);
            }
            
            updateNotes();
            drawGame();
            game.animationFrame = requestAnimationFrame(gameLoop);
        }

        // æ›´æ–°éŸ³ç¬¦çŠ¶æ€
        function updateNotes() {
            const judgementLineY = getJudgementLineY();
            const config = JUDGEMENT_CONFIG[game.judgementLevel];
            
            for (let i = game.notes.length - 1; i >= 0; i--) {
                const note = game.notes[i];
                note.position += note.speed;
                
                // åªæœ‰å½“éŸ³ç¬¦å®Œå…¨é€šè¿‡åˆ¤å®šåŒºåŸŸä¸”æ²¡æœ‰è¢«å‡»ä¸­æ—¶ï¼Œæ‰æ ‡è®°ä¸ºMISS
                if (!note.hit && !note.missed && note.position > judgementLineY + config.good) {
                    note.missed = true;
                    note.judgement = 'MISS';
                    game.combo = 0;
                    game.missCount++;
                    updateStats();
                    updateComboDisplay();
                }
                
                if (note.position > canvas.height + 100) {
                    returnNoteToPool(game.notes[i]);
                    game.notes.splice(i, 1);
                }
            }
            
            // æ›´æ–°æŒ‰é”®é«˜äº®çŠ¶æ€ - æ£€æŸ¥æ¯ä¸ªè½¨é“çš„æŒ‰é”®æŒç»­æ—¶é—´
            const now = Date.now();
            for (let i = 0; i < 4; i++) {
                if (game.keyPressStates[i] && (now - game.keyPressTimes[i] > game.keyPressDuration)) {
                    game.keyPressStates[i] = false;
                }
            }
        }

        // ç»˜åˆ¶åˆ¤å®šåŒºåŸŸ
        function drawJudgementArea() {
            const judgementLineY = getJudgementLineY();
            const config = JUDGEMENT_CONFIG[game.judgementLevel];
            
            // ç»˜åˆ¶åˆ¤å®šåŒºåŸŸèƒŒæ™¯
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fillRect(0, judgementLineY - config.good, canvas.width, config.good * 2);
            
            // ç»˜åˆ¶åˆ¤å®šçº¿
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // GOOD çº¿
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY - config.good);
            ctx.lineTo(canvas.width, judgementLineY - config.good);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY + config.good);
            ctx.lineTo(canvas.width, judgementLineY + config.good);
            ctx.stroke();
            
            // GREAT çº¿
            ctx.strokeStyle = '#00FF00';
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY - config.great);
            ctx.lineTo(canvas.width, judgementLineY - config.great);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY + config.great);
            ctx.lineTo(canvas.width, judgementLineY + config.great);
            ctx.stroke();
            
            // PERFECT çº¿
            ctx.strokeStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY - config.perfect);
            ctx.lineTo(canvas.width, judgementLineY - config.perfect);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY + config.perfect);
            ctx.lineTo(canvas.width, judgementLineY + config.perfect);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            if (!ctx) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const laneWidth = canvas.width / 4;
            const judgementLineY = getJudgementLineY();
            
            // ç»˜åˆ¶åˆ¤å®šåŒºåŸŸ
            drawJudgementArea();
            
            // ç»˜åˆ¶è½¨é“çº¿
            ctx.strokeStyle = '#4a6572';
            ctx.lineWidth = 2;
            for (let i = 1; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(i * laneWidth, 0);
                ctx.lineTo(i * laneWidth, canvas.height);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶åˆ¤å®šçº¿
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY);
            ctx.lineTo(canvas.width, judgementLineY);
            ctx.stroke();
            
            // ç»˜åˆ¶é”®ç›˜æŒ‰ä¸‹æ•ˆæœ - ä½¿ç”¨æ–°çš„æŒ‰é”®çŠ¶æ€ç³»ç»Ÿ
            for (let i = 0; i < 4; i++) {
                if (game.keyPressStates[i]) {
                    const x = i * laneWidth;
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fillRect(x, 0, laneWidth, canvas.height);
                    
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    const keyLabels = ['D', 'F', 'J', 'K'];
                    ctx.fillText(keyLabels[i], x + laneWidth/2, 30);
                }
            }
            
            // ç»˜åˆ¶éŸ³ç¬¦
            game.notes.forEach(note => {
                const x = note.lane * laneWidth;
                
                if (note.judgement === 'PERFECT') {
                    ctx.fillStyle = '#FFD700';
                } else if (note.judgement === 'GREAT') {
                    ctx.fillStyle = '#00FF00';
                } else if (note.judgement === 'GOOD') {
                    ctx.fillStyle = '#3498db';
                } else if (note.missed) {
                    ctx.fillStyle = '#e74c3c';
                } else {
                    ctx.fillStyle = '#9b59b6';
                }
                
                ctx.fillRect(x + 5, note.position, laneWidth - 10, 40);
                
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.strokeRect(x + 5, note.position, laneWidth - 10, 40);
                
                if (note.judgement) {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(note.judgement, x + laneWidth/2, note.position + 25);
                }
            });
            
            // ç»˜åˆ¶æ¸¸æˆçŠ¶æ€
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('BPM: ' + (game.challengeMode ? Math.round(game.challengeBPM) : game.bpm), 10, 30);
            ctx.fillText('æµé€Ÿ: ' + game.speed.toFixed(1) + 'x', 10, 55);
            ctx.fillText('åˆ¤å®š: ' + JUDGEMENT_LABELS[game.judgementLevel], 10, 80);
            
            // ç»˜åˆ¶é”®ç›˜æç¤º
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = 'bold 18px Arial';
            const keys = ['D', 'F', 'J', 'K'];
            for (let i = 0; i < 4; i++) {
                const x = i * laneWidth + laneWidth / 2;
                ctx.fillText(keys[i], x, canvas.height - 20);
            }

            // ç»˜åˆ¶ç­‰å¾…ç©ºæ ¼æç¤º
            if (game.waitingForSpace) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', initGame);

        console.log('ğŸ® 4kéŸ³æ¸¸åº•åŠ›è®­ç»ƒå™¨åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
