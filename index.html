<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>">
    <title>4kéŸ³æ¸¸åº•åŠ›è®­ç»ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: white;
        }
        
        .sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 10;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            color: #FFD700;
        }
        
        .control-group {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #dee2e6;
            border-radius: 4px;
            outline: none;
        }
        
        .value-display {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            color: #FFD700;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #startBtn {
            background: #28a745;
            color: white;
        }
        
        #startBtn:hover {
            background: #218838;
        }
        
        #pauseBtn {
            background: #ffc107;
            color: black;
        }
        
        #pauseBtn:hover {
            background: #e0a800;
        }
        
        #resetBtn {
            background: #dc3545;
            color: white;
        }
        
        #resetBtn:hover {
            background: #c82333;
        }
        
        #soundToggle {
            background: #17a2b8;
            color: white;
        }
        
        #soundToggle:hover {
            background: #138496;
        }
        
        #sponsorBtn {
            background: #9b59b6;
            color: white;
        }
        
        #sponsorBtn:hover {
            background: #8e44ad;
        }
        
        #toggleSidebar {
            position: fixed;
            top: 50%;
            left: 300px;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 0 5px 5px 0;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 20;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar.collapsed + #toggleSidebar {
            left: 60px;
        }
        
        #toggleSidebar:hover {
            background: rgba(0, 0, 0, 0.9);
            width: 25px;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            display: block;
            touch-action: none;
        }
        
        .game-stats {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 5;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .stat-label {
            font-size: 14px;
            color: #ccc;
            margin-top: 2px;
        }
        
        .judgement-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 5;
            text-align: center;
        }

        .judgement-subtext {
            font-size: 36px;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .judgement-visual {
            height: 20px;
            background: linear-gradient(90deg, 
                #e74c3c 0%, 
                #e74c3c 20%, 
                #3498db 20%, 
                #3498db 40%, 
                #00FF00 40%, 
                #00FF00 60%, 
                #FFD700 60%, 
                #FFD700 80%, 
                #e74c3c 80%, 
                #e74c3c 100%);
            border-radius: 10px;
            margin-top: 5px;
            position: relative;
        }
        
        .judgement-center {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 30px;
            background: #FFFFFF;
        }

        .start-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 30px 60px;
            border-radius: 15px;
            text-align: center;
            font-size: 24px;
            z-index: 10;
            pointer-events: none;
            width: 80%;
            max-width: 600px;
        }
        
        .combo-display {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 5;
        }
        
        .sidebar.collapsed {
            width: 60px;
            overflow: hidden;
            padding: 10px;
        }
        
        .sidebar.collapsed .control-group,
        .sidebar.collapsed .button-group,
        .sidebar.collapsed h1 {
            display: none;
        }
        
        .sidebar.collapsed .button-group {
            align-items: center;
        }
        
        .sidebar.collapsed button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .bpm-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .bpm-input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            text-align: center;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .bpm-input:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .bpm-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }
        
        .sponsor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .sponsor-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            color: #333;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }
        
        .sponsor-content h2 {
            margin-bottom: 20px;
            color: #9b59b6;
        }
        
        .sponsor-content p {
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .qr-codes {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 10px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            border: 1px solid #ddd;
            padding: 10px;
        }
        
        .qr-code img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .close-btn:hover {
            background: #c82333;
        }
        
        .cat-girl-text {
            font-family: 'Microsoft YaHei', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #555;
            text-align: left;
            margin-bottom: 20px;
            background: #f9f0ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .cat-girl-text::before {
            content: "ğŸ± ";
            font-size: 18px;
        }
        
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .no-context-menu {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .touch-feedback {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            pointer-events: none;
            z-index: 15;
            transition: opacity 0.2s;
        }

        /* ç§»åŠ¨ç«¯å¼€å§‹æŒ‰é’® */
        .mobile-start-btn {
            display: none;
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .mobile-start-btn:hover {
            background: #218838;
        }

        /* ç§»åŠ¨ç«¯æ ·å¼ */
        @media (max-width: 768px) {
            .mobile-start-btn {
                display: block;
            }
            
            .sidebar {
                width: 100%;
                position: absolute;
                height: 100%;
                z-index: 30;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            #toggleSidebar {
                left: 0;
                transform: translateY(-50%);
                border-radius: 0 5px 5px 0;
                width: 25px;
                height: 80px;
                background: rgba(0, 0, 0, 0.8);
                z-index: 35;
            }
            
            .sidebar.open + #toggleSidebar {
                left: 100%;
                transform: translate(-100%, -50%);
                border-radius: 5px 0 0 5px;
            }
            
            .game-stats {
                flex-wrap: wrap;
                padding: 5px 10px;
            }
            
            .stat-item {
                flex: 1 0 25%;
                margin-bottom: 5px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            .start-hint {
                padding: 20px;
                font-size: 18px;
            }
            
            .start-hint h2 {
                font-size: 22px;
            }
            
            /* ç§»åŠ¨ç«¯å¼€å§‹æŒ‰é’®åœ¨æç¤ºæ¡†å†… */
            .hint-start-btn {
                display: block;
                margin: 20px auto;
                padding: 12px 25px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                pointer-events: auto;
            }
        }
    </style>
</head>
<body class="no-context-menu">
    <div class="sidebar" id="sidebar">
        <h1>ğŸµ4kåº•åŠ›è®­ç»ƒğŸµ</h1>
        
        <div class="control-group">
            <label>BPMï¼ˆæ¯åˆ†é’ŸèŠ‚æ‹æ•°ï¼‰</label>
            <div class="bpm-input-container">
                <input type="number" id="bpmInput" class="bpm-input" placeholder="60~1200" min="60" max="1200" value="120">
                <span>BPM</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>æ–¹å—æµé€Ÿ</label>
            <input type="range" id="speedSlider" min="0.5" max="5.0" value="1.0" step="0.1">
            <div class="value-display">
                <span>0.5x</span>
                <span id="speedValue">1.0x</span>
                <span>5.0x</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>åˆ¤å®šåŒºåŸŸå¤§å°</label>
            <input type="range" id="judgementSlider" min="1" max="10" value="8" step="1">
            <div class="value-display">
                <span>ä¸¥æ ¼</span>
                <span id="judgementValue">å®½æ¾</span>
                <span>å®½æ¾</span>
            </div>
            <div class="judgement-visual">
                <div class="judgement-center"></div>
            </div>
        </div>
        
        <div class="control-group">
            <label>åˆ¤å®šçº¿ä½ç½®</label>
            <input type="range" id="linePositionSlider" min="20" max="80" value="70" step="5">
            <div class="value-display">
                <span>åº•éƒ¨</span>
                <span id="linePositionValue">70%</span>
                <span>é¡¶éƒ¨</span>
            </div>
        </div>
        
        <div class="button-group">
            <button id="startBtn">å¼€å§‹è®­ç»ƒ</button>
            <button id="pauseBtn">æš‚åœ</button>
            <button id="resetBtn">é‡ç½®</button>
            <button id="soundToggle">éŸ³æ•ˆ: å¼€å¯</button>
            <button id="sponsorBtn">èµåŠ©æ”¯æŒ</button>
        </div>
    </div>
    
    <!-- ä¾§è¾¹æ æ”¶çº³æŒ‰é’®æ”¾åœ¨ä¾§è¾¹æ å¤–éƒ¨ -->
    <button id="toggleSidebar">â—€</button>
    
    <div class="game-area">
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-value" id="score">0</div>
                <div class="stat-label">åˆ†æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="combo">0</div>
                <div class="stat-label">è¿å‡»</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="maxCombo">0</div>
                <div class="stat-label">æœ€å¤§è¿å‡»</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracy">100%</div>
                <div class="stat-label">å‡†ç¡®ç‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="perfectCount">0</div>
                <div class="stat-label">PERFECT</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="greatCount">0</div>
                <div class="stat-label">GREAT</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="goodCount">0</div>
                <div class="stat-label">GOOD</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="missCount">0</div>
                <div class="stat-label">MISS</div>
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        <div class="judgement-display" id="judgementDisplay"></div>
        <div class="combo-display" id="comboDisplay"></div>
        
        <!-- ç§»åŠ¨è®¾å¤‡ä¸“ç”¨å¼€å§‹æŒ‰é’® -->
        <button class="mobile-start-btn" id="mobileStartBtn">å¼€å§‹ä¸‹è½</button>
        
        <div class="start-hint" id="startHint" style="display: none;">
            <h2>ğŸµ 4kéŸ³æ¸¸åº•åŠ›è®­ç»ƒå™¨ ğŸµ</h2>
            <p style="margin: 20px 0; font-size: 28px;">æŒ‰ä¸‹ç©ºæ ¼é”®æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹éŸ³ç¬¦ä¸‹è½</p>
            <button class="hint-start-btn" id="hintStartBtn">å¼€å§‹ä¸‹è½</button>
            <div style="font-size: 18px; line-height: 1.8;">
                <p>ğŸ¯ åˆ†æ•°: PERFECT:100 | GREAT:80 | GOOD:60 | MISS:0</p>
                <p>â¸ï¸ ç©ºæ ¼é”®: å¼€å§‹/æš‚åœæ¸¸æˆ</p>
                <p id="currentSettings">âš¡ BPM: 120 | æµé€Ÿ: 1.0x</p>
            </div>
        </div>
    </div>

    <!-- èµåŠ©å¼¹çª— -->
    <div class="sponsor-modal" id="sponsorModal">
        <div class="sponsor-content">
            <h2>å–µ~ æ„Ÿè°¢æ‚¨å–œæ¬¢è¿™ä¸ªéŸ³æ¸¸è®­ç»ƒå™¨ï¼</h2>
            
            <div class="cat-girl-text">
                å–µå‘œ~ é˜ä¸‹ç©å¾—å¼€å¿ƒå—ï¼Ÿå¯¹æ‚¨çš„åº•åŠ›æå‡æœ‰å¸®åŠ©çš„è¯ï¼Œå¯ä»¥è€ƒè™‘èµåŠ©æ”¯æŒä¸€ä¸‹å–µ~<br><br>
                
                æ‚¨çš„æ”¯æŒå°†å¸®åŠ©æˆ‘ç»§ç»­æ”¹è¿›å’Œå¼€å‘æ›´å¤šæœ‰è¶£çš„åŠŸèƒ½çš„å–µï¼<br><br>
                
                ç¥æ‚¨æ—©æ—¥è¾¾æˆå…¨è¿FCï¼Œå†²å‡»APå…¨å®Œç¾ï¼
            </div>
            
            <div class="qr-codes">
                <div class="qr-code">
                    <img src="WeChatQRCode.jpg" alt="å¾®ä¿¡æ”¶æ¬¾ç ">
                    <span>å¾®ä¿¡æ”¯ä»˜</span>
                </div>
                <div class="qr-code">
                    <img src="AlipayQRCode.jpg" alt="æ”¯ä»˜å®æ”¶æ¬¾ç ">
                    <span>æ”¯ä»˜å®</span>
                </div>
            </div>
            
            <p>æ‰«æä¸Šæ–¹äºŒç»´ç è¿›è¡ŒèµåŠ©ï¼Œæ„Ÿè°¢æ‚¨çš„æ”¯æŒå–µ~</p>
            <button class="close-btn" id="closeSponsorModal">å…³é—­</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ ¸å¿ƒå˜é‡
        let game = {
            bpm: 120,
            speed: 1.0,
            judgementLevel: 8,
            linePosition: 70,
            isPlaying: false,
            notes: [],
            score: 0,
            combo: 0,
            maxCombo: 0,
            hitCount: 0,
            totalNotes: 0,
            perfectCount: 0,
            greatCount: 0,
            goodCount: 0,
            missCount: 0,
            noteInterval: null,
            animationFrame: null,
            keyPressEffect: {
                lane: -1,
                time: 0,
                duration: 100
            },
            waitingForSpace: false,
            soundEnabled: true,
            // ç§»åŠ¨ç«¯è§¦æ‘¸ç›¸å…³
            touchActive: false,
            currentTouchLane: -1,
            touchFeedback: null,
            // ä¾§è¾¹æ çŠ¶æ€
            sidebarCollapsed: false
        };

        // è·å–HTMLå…ƒç´ 
        let canvas, ctx;
        let bpmInput;
        let speedSlider, judgementSlider, linePositionSlider;
        let speedValue, judgementValue, linePositionValue;
        let startBtn, pauseBtn, resetBtn, toggleSidebar, soundToggle, sponsorBtn;
        let scoreDisplay, comboDisplay, accuracyDisplay, maxComboDisplay;
        let perfectCountDisplay, greatCountDisplay, goodCountDisplay, missCountDisplay;
        let judgementDisplay, startHint, comboDisplayElement, currentSettings;
        let sponsorModal, closeSponsorModal;
        let mobileStartBtn, hintStartBtn;

        // éŸ³æ•ˆ
        let audioContext;
        let soundBuffers = {};

        // é”®ç›˜æ˜ å°„
        const KEY_MAPPING = {
            'KeyD': 0,
            'KeyF': 1,  
            'KeyJ': 2,
            'KeyK': 3
        };

        // åˆ¤å®šçª—å£é…ç½®
        const JUDGEMENT_CONFIG = {
            1: { perfect: 15, great: 30, good: 45 },
            2: { perfect: 18, great: 36, good: 54 },
            3: { perfect: 21, great: 42, good: 63 },
            4: { perfect: 24, great: 48, good: 72 },
            5: { perfect: 27, great: 54, good: 81 },
            6: { perfect: 30, great: 60, good: 90 },
            7: { perfect: 33, great: 66, good: 99 },
            8: { perfect: 36, great: 72, good: 108 },
            9: { perfect: 39, great: 78, good: 117 },
            10: { perfect: 42, great: 84, good: 126 }
        };

        // åˆ¤å®šæ–‡å­—æè¿°
        const JUDGEMENT_LABELS = {
            1: "è¶…ä¸¥æ ¼", 2: "ä¸¥æ ¼", 3: "è¾ƒä¸¥æ ¼", 4: "ç¨ä¸¥æ ¼", 5: "ä¸­ç­‰",
            6: "ç¨å®½æ¾", 7: "è¾ƒå®½æ¾", 8: "å®½æ¾", 9: "å¾ˆå®½æ¾", 10: "è¶…å®½æ¾"
        };

        // åˆ†æ•°é…ç½®
        const SCORE_CONFIG = {
            PERFECT: 100,
            GREAT: 80,
            GOOD: 60,
            MISS: 0
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            console.log('ğŸ® å¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            
            try {
                // è·å–æ‰€æœ‰HTMLå…ƒç´ 
                canvas = document.getElementById('gameCanvas');
                if (!canvas) throw new Error('æ‰¾ä¸åˆ°canvaså…ƒç´ ');
                
                // è®¾ç½®canvaså°ºå¯¸ä¸ºå…¨å±
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                
                ctx = canvas.getContext('2d');
                if (!ctx) throw new Error('æ— æ³•è·å–canvasä¸Šä¸‹æ–‡');
                
                // è·å–è¾“å…¥å…ƒç´ 
                bpmInput = document.getElementById('bpmInput');
                speedSlider = document.getElementById('speedSlider');
                judgementSlider = document.getElementById('judgementSlider');
                linePositionSlider = document.getElementById('linePositionSlider');
                
                // è·å–æ˜¾ç¤ºå…ƒç´ 
                speedValue = document.getElementById('speedValue');
                judgementValue = document.getElementById('judgementValue');
                linePositionValue = document.getElementById('linePositionValue');
                
                // è·å–æŒ‰é’®å…ƒç´ 
                startBtn = document.getElementById('startBtn');
                pauseBtn = document.getElementById('pauseBtn');
                resetBtn = document.getElementById('resetBtn');
                toggleSidebar = document.getElementById('toggleSidebar');
                soundToggle = document.getElementById('soundToggle');
                sponsorBtn = document.getElementById('sponsorBtn');
                
                // è·å–ç§»åŠ¨ç«¯æŒ‰é’®
                mobileStartBtn = document.getElementById('mobileStartBtn');
                hintStartBtn = document.getElementById('hintStartBtn');
                
                // è·å–ç»Ÿè®¡å…ƒç´ 
                scoreDisplay = document.getElementById('score');
                comboDisplay = document.getElementById('combo');
                accuracyDisplay = document.getElementById('accuracy');
                maxComboDisplay = document.getElementById('maxCombo');
                perfectCountDisplay = document.getElementById('perfectCount');
                greatCountDisplay = document.getElementById('greatCount');
                goodCountDisplay = document.getElementById('goodCount');
                missCountDisplay = document.getElementById('missCount');
                
                // è·å–å…¶ä»–å…ƒç´ 
                judgementDisplay = document.getElementById('judgementDisplay');
                startHint = document.getElementById('startHint');
                comboDisplayElement = document.getElementById('comboDisplay');
                currentSettings = document.getElementById('currentSettings');
                
                // è·å–èµåŠ©å¼¹çª—å…ƒç´ 
                sponsorModal = document.getElementById('sponsorModal');
                closeSponsorModal = document.getElementById('closeSponsorModal');
                
                console.log('âœ… æ‰€æœ‰HTMLå…ƒç´ è·å–æˆåŠŸ');
                
                // åˆå§‹åŒ–éŸ³æ•ˆ
                initAudio();
                
                // è®¾ç½®åˆå§‹å€¼
                updateSliderValues();
                
                // è®¾ç½®è¾“å…¥äº‹ä»¶
                setupInputs();
                
                // è®¾ç½®æŒ‰é’®äº‹ä»¶
                setupButtons();
                
                // è®¾ç½®é”®ç›˜å’Œè§¦æ‘¸äº‹ä»¶
                setupInputEvents();
                
                // åˆ›å»ºè§¦æ‘¸åé¦ˆå…ƒç´ 
                createTouchFeedback();
                
                // åˆå§‹ç»˜åˆ¶
                drawGame();
                
                console.log('ğŸ‰ æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                alert('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // åˆ›å»ºè§¦æ‘¸åé¦ˆå…ƒç´ 
        function createTouchFeedback() {
            game.touchFeedback = document.createElement('div');
            game.touchFeedback.className = 'touch-feedback';
            game.touchFeedback.style.display = 'none';
            document.querySelector('.game-area').appendChild(game.touchFeedback);
        }

        // æ˜¾ç¤ºè§¦æ‘¸åé¦ˆ
        function showTouchFeedback(lane) {
            if (!game.touchFeedback) return;
            
            const laneWidth = canvas.width / 4;
            const x = lane * laneWidth;
            
            game.touchFeedback.style.left = x + 'px';
            game.touchFeedback.style.width = laneWidth + 'px';
            game.touchFeedback.style.height = canvas.height + 'px';
            game.touchFeedback.style.display = 'block';
            game.touchFeedback.style.opacity = '1';
        }

        // éšè—è§¦æ‘¸åé¦ˆ
        function hideTouchFeedback() {
            if (!game.touchFeedback) return;
            
            game.touchFeedback.style.opacity = '0';
            setTimeout(() => {
                game.touchFeedback.style.display = 'none';
            }, 200);
        }

        // è°ƒæ•´canvaså°ºå¯¸
        function resizeCanvas() {
            const gameArea = document.querySelector('.game-area');
            canvas.width = gameArea.clientWidth;
            canvas.height = gameArea.clientHeight;
            
            // é‡æ–°ç»˜åˆ¶æ¸¸æˆ
            if (ctx) {
                drawGame();
            }
        }

        // åˆå§‹åŒ–éŸ³æ•ˆ
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºéŸ³æ•ˆ
                createSound('perfect', 800, 0.3);
                createSound('great', 600, 0.25);
                createSound('good', 400, 0.2);
                createSound('miss', 200, 0.3);
                createSound('click', 300, 0.1);
                
                console.log('ğŸ”Š éŸ³æ•ˆåˆå§‹åŒ–æˆåŠŸ');
            } catch (e) {
                console.error('âŒ éŸ³æ•ˆåˆå§‹åŒ–å¤±è´¥:', e);
                game.soundEnabled = false;
                soundToggle.textContent = 'éŸ³æ•ˆ: å…³é—­';
            }
        }

        // åˆ›å»ºéŸ³æ•ˆ
        function createSound(name, frequency, duration) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
            
            // å­˜å‚¨éŸ³æ•ˆ
            soundBuffers[name] = { oscillator, gainNode };
        }

        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(name) {
            if (!game.soundEnabled || !audioContext) return;
            
            try {
                createSound(name, 
                    name === 'perfect' ? 800 : 
                    name === 'great' ? 600 : 
                    name === 'good' ? 400 : 
                    name === 'miss' ? 200 : 300, 
                    0.2);
            } catch (e) {
                console.error('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
            }
        }

        // æ›´æ–°æ˜¾ç¤ºå€¼
        function updateSliderValues() {
            speedValue.textContent = game.speed.toFixed(1) + 'x';
            judgementValue.textContent = JUDGEMENT_LABELS[game.judgementLevel];
            linePositionValue.textContent = game.linePosition + '%';
            
            // æ›´æ–°å¼€å§‹æç¤ºä¸­çš„è®¾ç½®
            if (currentSettings) {
                currentSettings.textContent = `âš¡ BPM: ${game.bpm} | æµé€Ÿ: ${game.speed.toFixed(1)}x`;
            }
        }

        // å®‰å…¨è¾“å…¥éªŒè¯å‡½æ•°
        function sanitizeInput(value, min, max, defaultValue) {
            // è½¬æ¢ä¸ºæ•°å­—
            let numValue = parseInt(value);
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(numValue)) {
                return defaultValue;
            }
            
            // é™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…
            numValue = Math.max(min, Math.min(max, numValue));
            
            return numValue;
        }

        // æ›´æ–°BPMå€¼
        function updateBPM() {
            let value = sanitizeInput(bpmInput.value, 60, 1200, 120);
            game.bpm = value;
            bpmInput.value = value; // ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯å®‰å…¨å€¼
            updateSliderValues();
            
            if (game.isPlaying && !game.waitingForSpace) {
                restartGame();
            }
        }

        // è®¾ç½®è¾“å…¥äº‹ä»¶
        function setupInputs() {
            // BPMè¾“å…¥æ¡†äº‹ä»¶ - åªåœ¨å¤±å»ç„¦ç‚¹æˆ–æŒ‰å›è½¦æ—¶æ›´æ–°
            bpmInput.addEventListener('blur', function() {
                updateBPM();
            });
            
            // æŒ‰å›è½¦é”®æ—¶æ›´æ–°BPM
            bpmInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    updateBPM();
                    this.blur(); // å¤±å»ç„¦ç‚¹ï¼Œéšè—é”®ç›˜ï¼ˆåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼‰
                }
            });

            speedSlider.addEventListener('input', function() {
                game.speed = parseFloat(this.value);
                updateSliderValues();
                if (game.isPlaying && !game.waitingForSpace) {
                    restartGame();
                }
            });

            judgementSlider.addEventListener('input', function() {
                game.judgementLevel = parseInt(this.value);
                updateSliderValues();
                drawGame(); // ç«‹å³æ›´æ–°ç”»é¢
            });

            linePositionSlider.addEventListener('input', function() {
                game.linePosition = parseInt(this.value);
                updateSliderValues();
                drawGame(); // ç«‹å³æ›´æ–°ç”»é¢
            });
        }

        // è®¾ç½®æŒ‰é’®äº‹ä»¶
        function setupButtons() {
            startBtn.addEventListener('click', startGame);
            pauseBtn.addEventListener('click', pauseGame);
            resetBtn.addEventListener('click', resetGame);
            
            // ç§»åŠ¨ç«¯å¼€å§‹æŒ‰é’® - æ˜ å°„ä¸ºç©ºæ ¼é”®äº‹ä»¶
            mobileStartBtn.addEventListener('click', function() {
                // åˆ›å»ºå¹¶è§¦å‘ç©ºæ ¼é”®æŒ‰ä¸‹äº‹ä»¶
                const spaceEvent = new KeyboardEvent('keydown', {
                    code: 'Space',
                    key: ' ',
                    keyCode: 32,
                    which: 32,
                    bubbles: true
                });
                document.dispatchEvent(spaceEvent);
            });
            
            hintStartBtn.addEventListener('click', function() {
                // åˆ›å»ºå¹¶è§¦å‘ç©ºæ ¼é”®æŒ‰ä¸‹äº‹ä»¶
                const spaceEvent = new KeyboardEvent('keydown', {
                    code: 'Space',
                    key: ' ',
                    keyCode: 32,
                    which: 32,
                    bubbles: true
                });
                document.dispatchEvent(spaceEvent);
            });
            
            // ä¾§è¾¹æ åˆ‡æ¢
            toggleSidebar.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // ç§»åŠ¨ç«¯ï¼šä¾§è¾¹æ æ»‘åŠ¨
                    sidebar.classList.toggle('open');
                    this.textContent = sidebar.classList.contains('open') ? 'â–¶' : 'â—€';
                } else {
                    // æ¡Œé¢ç«¯ï¼šä¾§è¾¹æ æ”¶èµ·/å±•å¼€
                    sidebar.classList.toggle('collapsed');
                    game.sidebarCollapsed = sidebar.classList.contains('collapsed');
                    this.textContent = game.sidebarCollapsed ? 'â–¶' : 'â—€';
                    
                    // æ›´æ–°æŒ‰é’®ä½ç½®
                    const newLeft = game.sidebarCollapsed ? 60 : 300;
                    this.style.left = newLeft + 'px';
                }
                
                // é‡æ–°è°ƒæ•´canvaså¤§å°
                setTimeout(resizeCanvas, 300);
            });
            
            // éŸ³æ•ˆåˆ‡æ¢
            soundToggle.addEventListener('click', function() {
                game.soundEnabled = !game.soundEnabled;
                this.textContent = game.soundEnabled ? 'éŸ³æ•ˆ: å¼€å¯' : 'éŸ³æ•ˆ: å…³é—­';
                playSound('click');
            });
            
            // èµåŠ©æŒ‰é’®
            sponsorBtn.addEventListener('click', function() {
                sponsorModal.style.display = 'flex';
                playSound('click');
            });
            
            // å…³é—­èµåŠ©å¼¹çª—
            closeSponsorModal.addEventListener('click', function() {
                sponsorModal.style.display = 'none';
            });
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            sponsorModal.addEventListener('click', function(e) {
                if (e.target === sponsorModal) {
                    sponsorModal.style.display = 'none';
                }
            });
        }

        // è®¾ç½®è¾“å…¥äº‹ä»¶
        function setupInputEvents() {
            // ç”»å¸ƒç‚¹å‡»äº‹ä»¶
            canvas.addEventListener('click', handleCanvasClick);
            
            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });
            
            // é˜²æ­¢é¡µé¢æ»šåŠ¨
            document.addEventListener('touchmove', function(e) {
                if (e.target === canvas) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space') {
                    e.preventDefault();
                }
            });
            
            // é˜²æ­¢å³é”®èœå•
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
        }

        // å¤„ç†è§¦æ‘¸å¼€å§‹
        function handleTouchStart(event) {
            if (!game.isPlaying || game.waitingForSpace) return;
            
            event.preventDefault();
            game.touchActive = true;
            
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            
            // ä¿®å¤ä¾§è¾¹æ æ”¶èµ·æ—¶çš„è§¦æ‘¸å®šä½é—®é¢˜
            let adjustedX = x;
            if (game.sidebarCollapsed && window.innerWidth > 768) {
                // ä¾§è¾¹æ æ”¶èµ·æ—¶ï¼Œcanvaså·¦ä¾§æœ‰60pxçš„ä¾§è¾¹æ ç©ºé—´
                adjustedX = x - 60;
            }
            
            const laneWidth = canvas.width / 4;
            const lane = Math.floor(adjustedX / laneWidth);
            
            // ç¡®ä¿laneåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (lane < 0 || lane > 3) return;
            
            game.currentTouchLane = lane;
            game.keyPressEffect.lane = lane;
            game.keyPressEffect.time = Date.now();
            
            showTouchFeedback(lane);
            checkHit(lane);
        }

        // å¤„ç†è§¦æ‘¸ç§»åŠ¨
        function handleTouchMove(event) {
            if (!game.touchActive || !game.isPlaying || game.waitingForSpace) return;
            
            event.preventDefault();
            
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            
            // ä¿®å¤ä¾§è¾¹æ æ”¶èµ·æ—¶çš„è§¦æ‘¸å®šä½é—®é¢˜
            let adjustedX = x;
            if (game.sidebarCollapsed && window.innerWidth > 768) {
                adjustedX = x - 60;
            }
            
            const laneWidth = canvas.width / 4;
            const lane = Math.floor(adjustedX / laneWidth);
            
            // ç¡®ä¿laneåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (lane < 0 || lane > 3) return;
            
            // å¦‚æœç§»åŠ¨åˆ°æ–°çš„è½¨é“ï¼Œè§¦å‘è¯¥è½¨é“çš„æŒ‰é”®
            if (lane !== game.currentTouchLane) {
                game.currentTouchLane = lane;
                game.keyPressEffect.lane = lane;
                game.keyPressEffect.time = Date.now();
                
                showTouchFeedback(lane);
                checkHit(lane);
            }
        }

        // å¤„ç†è§¦æ‘¸ç»“æŸ
        function handleTouchEnd(event) {
            event.preventDefault();
            game.touchActive = false;
            game.currentTouchLane = -1;
            game.keyPressEffect.lane = -1;
            hideTouchFeedback();
        }

        // è·å–åˆ¤å®šçº¿Yåæ ‡
        function getJudgementLineY() {
            return canvas.height * (game.linePosition / 100);
        }

        // å¤„ç†é”®ç›˜æŒ‰ä¸‹
        function handleKeyDown(event) {
            // ç©ºæ ¼é”®å¤„ç†
            if (event.code === 'Space') {
                event.preventDefault();
                
                if (game.waitingForSpace) {
                    console.log('ğŸµ å¼€å§‹éŸ³ç¬¦ç”Ÿæˆ');
                    game.waitingForSpace = false;
                    startHint.style.display = 'none';
                    mobileStartBtn.style.display = 'none';
                    startNoteGeneration();
                } else if (game.isPlaying) {
                    console.log('â¸ï¸ æš‚åœ/ç»§ç»­æ¸¸æˆ');
                    pauseGame();
                } else {
                    // æ¸¸æˆæš‚åœçŠ¶æ€ä¸‹æŒ‰ç©ºæ ¼é”®ç»§ç»­æ¸¸æˆ
                    pauseGame();
                }
                return;
            }
            
            if (!game.isPlaying || game.waitingForSpace) return;
            
            const lane = KEY_MAPPING[event.code];
            if (lane !== undefined) {
                game.keyPressEffect.lane = lane;
                game.keyPressEffect.time = Date.now();
                checkHit(lane);
                event.preventDefault();
            }
        }

        // å¤„ç†é”®ç›˜é‡Šæ”¾
        function handleKeyUp(event) {
            const lane = KEY_MAPPING[event.code];
            if (lane !== undefined && game.keyPressEffect.lane === lane) {
                game.keyPressEffect.lane = -1;
                event.preventDefault();
            }
        }

        // è®¡ç®—éŸ³ç¬¦ç”Ÿæˆé—´éš”
        function calculateNoteInterval() {
            return (60000 / game.bpm) * 2;
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            console.log('ğŸš€ å¼€å§‹æ¸¸æˆ');
            if (game.isPlaying) return;
            
            // ç¡®ä¿BPMæ˜¯æœ€æ–°çš„
            updateBPM();
            
            resetGameState();
            game.isPlaying = true;
            game.waitingForSpace = true;
            
            updateStats();
            startHint.style.display = 'block';
            
            // æ˜¾ç¤ºç§»åŠ¨ç«¯å¼€å§‹æŒ‰é’®
            if (window.innerWidth <= 768) {
                mobileStartBtn.style.display = 'block';
            }
            
            gameLoop();
            
            startBtn.textContent = "æ¸¸æˆä¸­...";
            startBtn.disabled = true;
            pauseBtn.textContent = "æš‚åœ";
            
            console.log('ğŸ”„ æ¸¸æˆå¾ªç¯å¯åŠ¨ï¼Œç­‰å¾…ç©ºæ ¼é”®...');
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGameState() {
            game.notes = [];
            game.score = 0;
            game.combo = 0;
            game.maxCombo = 0;
            game.hitCount = 0;
            game.totalNotes = 0;
            game.perfectCount = 0;
            game.greatCount = 0;
            game.goodCount = 0;
            game.missCount = 0;
            game.keyPressEffect.lane = -1;
            game.waitingForSpace = false;
            game.touchActive = false;
            game.currentTouchLane = -1;
        }

        // å¼€å§‹éŸ³ç¬¦ç”Ÿæˆ
        function startNoteGeneration() {
            const interval = calculateNoteInterval();
            console.log('ğŸ“ éŸ³ç¬¦ç”Ÿæˆé—´éš”:', interval + 'ms');
            
            if (game.noteInterval) {
                clearInterval(game.noteInterval);
            }
            
            game.noteInterval = setInterval(() => {
                createNote();
            }, interval);
        }

        // æš‚åœæ¸¸æˆ
        function pauseGame() {
            if (game.waitingForSpace) return;
            
            console.log('â¸ï¸ åˆ‡æ¢æš‚åœçŠ¶æ€');
            game.isPlaying = !game.isPlaying;
            
            if (!game.isPlaying) {
                if (game.noteInterval) {
                    clearInterval(game.noteInterval);
                    game.noteInterval = null;
                }
                pauseBtn.textContent = "ç»§ç»­";
            } else {
                startNoteGeneration();
                gameLoop(); // é‡æ–°å¼€å§‹æ¸¸æˆå¾ªç¯
                pauseBtn.textContent = "æš‚åœ";
            }
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            console.log('ğŸ”„ é‡ç½®æ¸¸æˆ');
            game.isPlaying = false;
            game.waitingForSpace = false;
            
            if (game.noteInterval) {
                clearInterval(game.noteInterval);
                game.noteInterval = null;
            }
            
            if (game.animationFrame) {
                cancelAnimationFrame(game.animationFrame);
                game.animationFrame = null;
            }
            
            resetGameState();
            updateStats();
            drawGame();
            
            startHint.style.display = 'none';
            mobileStartBtn.style.display = 'none';
            startBtn.textContent = "å¼€å§‹è®­ç»ƒ";
            startBtn.disabled = false;
            pauseBtn.textContent = "æš‚åœ";
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            console.log('ğŸ”„ é‡æ–°å¼€å§‹æ¸¸æˆ');
            if (!game.isPlaying) return;
            
            const wasPlaying = game.isPlaying;
            resetGame();
            if (wasPlaying) {
                startGame();
            }
        }

        // åˆ›å»ºæ–°éŸ³ç¬¦
        function createNote() {
            const lane = Math.floor(Math.random() * 4);
            const note = {
                id: Date.now() + Math.random(),
                lane: lane,
                position: -50,
                speed: 2 + (game.speed * 3),
                hit: false,
                missed: false,
                judgement: null,
                createTime: Date.now()
            };
            game.notes.push(note);
            game.totalNotes++;
            updateStats();
            
            console.log('ğŸµ åˆ›å»ºéŸ³ç¬¦ï¼Œè½¨é“:', lane, 'æ€»æ•°:', game.notes.length);
        }

        // å¤„ç†ç”»å¸ƒç‚¹å‡»
        function handleCanvasClick(event) {
            if (!game.isPlaying || game.waitingForSpace) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            
            // ä¿®å¤ä¾§è¾¹æ æ”¶èµ·æ—¶çš„ç‚¹å‡»å®šä½é—®é¢˜
            let adjustedX = x;
            if (game.sidebarCollapsed && window.innerWidth > 768) {
                adjustedX = x - 60;
            }
            
            const laneWidth = canvas.width / 4;
            const clickLane = Math.floor(adjustedX / laneWidth);
            
            // ç¡®ä¿laneåœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (clickLane < 0 || clickLane > 3) return;
            
            game.keyPressEffect.lane = clickLane;
            game.keyPressEffect.time = Date.now();
            checkHit(clickLane);
        }

        // æ£€æŸ¥ç‚¹å‡»åˆ¤å®š
        function checkHit(clickLane) {
            let hitFound = false;
            const judgementLineY = getJudgementLineY();
            const config = JUDGEMENT_CONFIG[game.judgementLevel];
            
            for (let i = 0; i < game.notes.length; i++) {
                const note = game.notes[i];
                
                if (note.hit || note.missed) continue;
                if (note.lane !== clickLane) continue;
                
                const distanceToLine = Math.abs(note.position - judgementLineY);
                
                if (distanceToLine <= config.perfect) {
                    processHit(note, 'PERFECT', '#FFD700', SCORE_CONFIG.PERFECT);
                    hitFound = true;
                    break;
                } else if (distanceToLine <= config.great) {
                    // åˆ¤æ–­æ˜¯EARLYè¿˜æ˜¯LATE
                    const timing = note.position < judgementLineY ? 'EARLY' : 'LATE';
                    processHit(note, 'GREAT', '#00FF00', SCORE_CONFIG.GREAT, timing);
                    hitFound = true;
                    break;
                } else if (distanceToLine <= config.good) {
                    // åˆ¤æ–­æ˜¯EARLYè¿˜æ˜¯LATE
                    const timing = note.position < judgementLineY ? 'EARLY' : 'LATE';
                    processHit(note, 'GOOD', '#3498db', SCORE_CONFIG.GOOD, timing);
                    hitFound = true;
                    break;
                }
            }
            
            // ä¸å†åœ¨æ²¡æœ‰å‘½ä¸­æ—¶è‡ªåŠ¨è®°å½•MISS
            // åªæœ‰å½“éŸ³ç¬¦é€šè¿‡åˆ¤å®šåŒºåŸŸæ—¶æ‰ä¼šè¢«æ ‡è®°ä¸ºMISS
            
            game.maxCombo = Math.max(game.maxCombo, game.combo);
            updateStats();
        }

        // å¤„ç†å‘½ä¸­é€»è¾‘
        function processHit(note, judgement, color, score, timing = null) {
            note.hit = true;
            note.judgement = judgement;
            
            // å¦‚æœæœ‰timingä¿¡æ¯ï¼Œæ˜¾ç¤ºEARLYæˆ–LATE
            if (timing) {
                showJudgement(judgement, color, timing);
            } else {
                showJudgement(judgement, color);
            }
            
            game.score += score;
            game.combo++;
            game.hitCount++;
            
            if (judgement === 'PERFECT') {
                game.perfectCount++;
                playSound('perfect');
            } else if (judgement === 'GREAT') {
                game.greatCount++;
                playSound('great');
            } else if (judgement === 'GOOD') {
                game.goodCount++;
                playSound('good');
            }
            
            updateComboDisplay();
        }

        // æ˜¾ç¤ºåˆ¤å®šæ•ˆæœ
        function showJudgement(text, color, timing = null) {
            if (timing) {
                judgementDisplay.innerHTML = `
                    <div>${text}</div>
                    <div class="judgement-subtext">${timing}</div>
                `;
            } else {
                judgementDisplay.innerHTML = `<div>${text}</div>`;
            }
            
            judgementDisplay.style.color = color;
            judgementDisplay.style.opacity = '1';
            
            setTimeout(() => {
                judgementDisplay.style.opacity = '0';
            }, 500);
        }

        // æ›´æ–°è¿å‡»æ˜¾ç¤º
        function updateComboDisplay() {
            if (game.combo > 0) {
                comboDisplayElement.textContent = game.combo + ' COMBO!';
                comboDisplayElement.style.opacity = '1';
                
                // æ ¹æ®è¿å‡»æ•°æ”¹å˜é¢œè‰²
                if (game.combo >= 50) {
                    comboDisplayElement.style.color = '#FF00FF';
                } else if (game.combo >= 30) {
                    comboDisplayElement.style.color = '#00FFFF';
                } else if (game.combo >= 10) {
                    comboDisplayElement.style.color = '#00FF00';
                } else {
                    comboDisplayElement.style.color = '#FFD700';
                }
                
                setTimeout(() => {
                    comboDisplayElement.style.opacity = '0';
                }, 1000);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            scoreDisplay.textContent = game.score;
            comboDisplay.textContent = game.combo;
            maxComboDisplay.textContent = game.maxCombo;
            perfectCountDisplay.textContent = game.perfectCount;
            greatCountDisplay.textContent = game.greatCount;
            goodCountDisplay.textContent = game.goodCount;
            missCountDisplay.textContent = game.missCount;
            
            // æ–°çš„å‡†ç¡®ç‡è®¡ç®—æ–¹å¼ï¼šå‡†ç¡®ç‡ = (å½“å‰æ€»åˆ† / (å·²åˆ¤å®šéŸ³ç¬¦æ•° Ã— 100)) Ã— 100
            const judgedNotes = game.hitCount + game.missCount;
            let accuracy = 100;
            
            if (judgedNotes > 0) {
                // æ¯ä¸ªéŸ³ç¬¦æ»¡åˆ†æ˜¯100åˆ†ï¼Œæ‰€ä»¥å·²åˆ¤å®šéŸ³ç¬¦æ•°çš„æ»¡åˆ†æ˜¯ judgedNotes Ã— 100
                const maxPossibleScore = judgedNotes * 100;
                accuracy = (game.score / maxPossibleScore) * 100;
            }
            
            accuracyDisplay.textContent = accuracy.toFixed(1) + '%';
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!game.isPlaying) return;
            
            updateNotes();
            drawGame();
            game.animationFrame = requestAnimationFrame(gameLoop);
        }

        // æ›´æ–°éŸ³ç¬¦çŠ¶æ€
        function updateNotes() {
            const judgementLineY = getJudgementLineY();
            const config = JUDGEMENT_CONFIG[game.judgementLevel];
            
            for (let i = game.notes.length - 1; i >= 0; i--) {
                const note = game.notes[i];
                note.position += note.speed;
                
                // åªæœ‰å½“éŸ³ç¬¦å®Œå…¨é€šè¿‡åˆ¤å®šåŒºåŸŸä¸”æ²¡æœ‰è¢«å‡»ä¸­æ—¶ï¼Œæ‰æ ‡è®°ä¸ºMISS
                if (!note.hit && !note.missed && note.position > judgementLineY + config.good) {
                    note.missed = true;
                    note.judgement = 'MISS';
                    game.combo = 0;
                    game.missCount++;
                    updateStats();
                    updateComboDisplay();
                }
                
                if (note.position > canvas.height + 100) {
                    game.notes.splice(i, 1);
                }
            }
            
            if (game.keyPressEffect.lane !== -1) {
                const pressDuration = Date.now() - game.keyPressEffect.time;
                if (pressDuration > game.keyPressEffect.duration) {
                    game.keyPressEffect.lane = -1;
                }
            }
        }

        // ç»˜åˆ¶åˆ¤å®šåŒºåŸŸ
        function drawJudgementArea() {
            const judgementLineY = getJudgementLineY();
            const config = JUDGEMENT_CONFIG[game.judgementLevel];
            
            // ç»˜åˆ¶åˆ¤å®šåŒºåŸŸèƒŒæ™¯
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.fillRect(0, judgementLineY - config.good, canvas.width, config.good * 2);
            
            // ç»˜åˆ¶åˆ¤å®šçº¿
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // GOOD çº¿
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY - config.good);
            ctx.lineTo(canvas.width, judgementLineY - config.good);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY + config.good);
            ctx.lineTo(canvas.width, judgementLineY + config.good);
            ctx.stroke();
            
            // GREAT çº¿
            ctx.strokeStyle = '#00FF00';
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY - config.great);
            ctx.lineTo(canvas.width, judgementLineY - config.great);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY + config.great);
            ctx.lineTo(canvas.width, judgementLineY + config.great);
            ctx.stroke();
            
            // PERFECT çº¿
            ctx.strokeStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY - config.perfect);
            ctx.lineTo(canvas.width, judgementLineY - config.perfect);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY + config.perfect);
            ctx.lineTo(canvas.width, judgementLineY + config.perfect);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }

        // ç»˜åˆ¶æ¸¸æˆ
        function drawGame() {
            if (!ctx) return;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const laneWidth = canvas.width / 4;
            const judgementLineY = getJudgementLineY();
            
            // ç»˜åˆ¶åˆ¤å®šåŒºåŸŸ
            drawJudgementArea();
            
            // ç»˜åˆ¶è½¨é“çº¿
            ctx.strokeStyle = '#4a6572';
            ctx.lineWidth = 2;
            for (let i = 1; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(i * laneWidth, 0);
                ctx.lineTo(i * laneWidth, canvas.height);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶åˆ¤å®šçº¿
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, judgementLineY);
            ctx.lineTo(canvas.width, judgementLineY);
            ctx.stroke();
            
            // ç»˜åˆ¶é”®ç›˜æŒ‰ä¸‹æ•ˆæœ
            if (game.keyPressEffect.lane !== -1) {
                const x = game.keyPressEffect.lane * laneWidth;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(x, 0, laneWidth, canvas.height);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                const keyLabels = ['D', 'F', 'J', 'K'];
                ctx.fillText(keyLabels[game.keyPressEffect.lane], x + laneWidth/2, 30);
            }
            
            // ç»˜åˆ¶éŸ³ç¬¦
            game.notes.forEach(note => {
                const x = note.lane * laneWidth;
                
                if (note.judgement === 'PERFECT') {
                    ctx.fillStyle = '#FFD700';
                } else if (note.judgement === 'GREAT') {
                    ctx.fillStyle = '#00FF00';
                } else if (note.judgement === 'GOOD') {
                    ctx.fillStyle = '#3498db';
                } else if (note.missed) {
                    ctx.fillStyle = '#e74c3c';
                } else {
                    ctx.fillStyle = '#9b59b6';
                }
                
                ctx.fillRect(x + 5, note.position, laneWidth - 10, 40);
                
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.strokeRect(x + 5, note.position, laneWidth - 10, 40);
                
                if (note.judgement) {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(note.judgement, x + laneWidth/2, note.position + 25);
                }
            });
            
            // ç»˜åˆ¶æ¸¸æˆçŠ¶æ€
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '16px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('BPM: ' + game.bpm, 10, 30);
            ctx.fillText('æµé€Ÿ: ' + game.speed.toFixed(1) + 'x', 10, 55);
            ctx.fillText('åˆ¤å®š: ' + JUDGEMENT_LABELS[game.judgementLevel], 10, 80);
            
            // ç»˜åˆ¶é”®ç›˜æç¤º
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = 'bold 18px Arial';
            const keys = ['D', 'F', 'J', 'K'];
            for (let i = 0; i < 4; i++) {
                const x = i * laneWidth + laneWidth / 2;
                ctx.fillText(keys[i], x, canvas.height - 20);
            }

            // ç»˜åˆ¶ç­‰å¾…ç©ºæ ¼æç¤º
            if (game.waitingForSpace) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', initGame);

        console.log('ğŸ® 4kéŸ³æ¸¸åº•åŠ›è®­ç»ƒå™¨åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
